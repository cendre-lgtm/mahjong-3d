<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ–°æ˜¥å–œæ…¶ç‰ˆï¼šå°æ—¥é›™åˆ¶ç«‹é«”éº»å°‡</title>
    <!-- Three.js Core -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- OrbitControls for Rotation -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <!-- TWEEN.js for smooth animation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #2d0a0a; font-family: 'Microsoft JhengHei', sans-serif; touch-action: none; user-select: none; -webkit-user-select: none; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50; }
        .interactive { pointer-events: auto; }
        canvas { display: block; }
        
        /* æ…¶ç¥ç‰¹æ•ˆ Canvas */
        #celebration-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 95;
        }

        /* ç¯€æ…¶æŒ‰éˆ• */
        .btn-festive { 
            background: linear-gradient(135deg, #d4af37 0%, #aa8a2e 100%); 
            color: #4a0404; border-radius: 12px; font-weight: 900; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); transition: all 0.1s;
            border: 2px solid #fff5d7; text-shadow: 0 1px 0 rgba(255,255,255,0.3);
            padding: 10px 16px; font-size: 1.1rem; min-width: 70px;
        }
        @media (min-width: 768px) { .btn-festive { padding: 14px 24px; font-size: 1.3rem; min-width: 90px; } }
        .btn-festive:active { transform: scale(0.95); }
        .btn-festive:disabled { filter: grayscale(1); opacity: 0.5; pointer-events: none; }
        
        .btn-hu-active {
            animation: pulse-gold 1.5s infinite;
            background: linear-gradient(135deg, #ff0000 0%, #990000 100%) !important;
            color: white !important; border-color: #ffd700 !important;
            box-shadow: 0 0 25px #ff0000 !important; transform: scale(1.1);
        }
        @keyframes pulse-gold { 0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); } 100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); } }

        .gold-text { color: #d4af37; text-shadow: 1px 1px 2px rgba(0,0,0,0.8); }
        .red-panel { background: rgba(139, 0, 0, 0.85); border: 2px solid #d4af37; box-shadow: 0 4px 20px rgba(0,0,0,0.6); }
        
        .btn-exit {
            background: linear-gradient(135deg, #c0392b 0%, #8e44ad 100%);
            color: white; border: 2px solid #e74c3c; border-radius: 50px; 
            font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            display: flex; align-items: center; gap: 5px; padding: 6px 12px; font-size: 0.8rem;
        }
        @media (min-width: 768px) { .btn-exit { padding: 8px 16px; font-size: 0.9rem; } }
        .btn-exit:active { transform: scale(0.95); }

        .preview-anim { animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        .tutorial-hint { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

        .ctrl-btn {
            background: rgba(0,0,0,0.6); border: 1px solid #d4af37; color: #d4af37; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            pointer-events: auto; cursor: pointer; margin-top: 10px; transition: all 0.3s;
            width: 40px; height: 40px; font-size: 20px;
        }
        .ctrl-btn.active { background: #d4af37; color: #000; box-shadow: 0 0 10px #d4af37; }
        .hidden-ctrl { display: none !important; }

        #preview-box.interactive-preview { cursor: pointer; pointer-events: auto; transition: transform 0.1s ease; }
        #preview-box.interactive-preview:active { transform: scale(0.85) !important; }
        
        @keyframes fadeUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-20px); } }
        .deduct-anim { position: absolute; color: #ff4d4d; font-weight: bold; animation: fadeUp 1s forwards; pointer-events: none; }
        
        .btn-chi-select {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: 2px solid #6ee7b7; color: white; padding: 10px 20px; border-radius: 12px; font-size: 1.5rem;
            display: flex; gap: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .btn-chi-select:active { transform: scale(0.95); }

        /* è½ç‰Œæç¤º */
        .tenpai-alert {
            position: absolute; top: -50px; left: 50%; transform: translateX(-50%);
            background: #ef4444; color: #fcd34d; font-weight: 900;
            padding: 5px 15px; border-radius: 20px; border: 2px solid #fcd34d;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.8);
            animation: bounce 1s infinite; pointer-events: none; white-space: nowrap;
        }
        @keyframes bounce { 0%, 100% { transform: translateX(-50%) translateY(0); } 50% { transform: translateX(-50%) translateY(-10px); } }
    </style>
</head>
<body>

<div id="game-container"></div>
<canvas id="celebration-canvas"></canvas>

<audio id="bgm" loop>
    <source src="https://raw.githubusercontent.com/cendre-lgtm/2026/refs/heads/main/(%E6%AD%A1%E5%BF%AB)%20%E6%96%B0%E5%B9%B4%EF%BD%9C%E5%85%8D%E8%B2%BB%E8%83%8C%E6%99%AF%E9%9F%B3%E6%A8%82%E4%B8%8B%E8%BC%89%EF%BD%9C%E7%84%A1%E7%89%88%E6%AC%8A%E9%85%8D%E6%A8%82%EF%BD%9CBGM%EF%BD%9CNCS%20%E3%80%90%E8%83%A4%E6%A8%82%E9%9F%B3%E6%A8%82%E3%80%91%20(7).mp3" type="audio/mpeg">
</audio>

<!-- UI åœ–å±¤ -->
<div id="ui-layer" class="flex flex-col justify-between p-2 md:p-4 h-full">
    <div class="flex justify-between items-start interactive w-full">
        <!-- å·¦ä¸Š -->
        <div class="flex flex-col gap-2 items-start max-w-[45%]">
            <button onclick="game.showMenu()" class="btn-exit"><span>ğŸ </span> <span class="hidden sm:inline">çµæŸç‰Œå±€</span><span class="sm:hidden">çµæŸ</span></button>
            <div id="game-info" class="red-panel text-white p-2 md:p-3 rounded-xl text-xs md:text-sm backdrop-blur-md shadow-lg w-full relative">
                <div class="flex items-center gap-2"><span class="text-yellow-400">ğŸ’°:</span><span id="credit-count" class="font-mono font-bold">10000</span></div>
                <div class="w-full h-[1px] bg-white/20 my-1"></div>
                <div>æ¨¡å¼: <span id="mode-display" class="font-bold text-yellow-300">-</span></div>
                <div>å‰©é¤˜: <span id="wall-count" class="font-mono text-yellow-200">--</span></div>
                <div class="mt-1 text-[10px] text-yellow-500/60">â™ª Music by èƒ¤æ¨‚éŸ³æ¨‚</div>
            </div>
        </div>
        <!-- å³ä¸Š -->
        <div id="score-board" class="red-panel text-white p-2 md:p-3 rounded-xl text-xs md:text-sm text-right backdrop-blur-md shadow-lg max-w-[50%]">
            <div id="p0-ui" class="gold-text transition-all duration-300">ç©å®¶ 1: <span id="s0">25000</span></div>
            <div id="p1-ui" class="transition-all duration-300">ç©å®¶ 2: <span id="s1">25000</span></div>
            <div id="p2-ui" class="transition-all duration-300">ç©å®¶ 3: <span id="s2">25000</span></div>
            <div id="p3-ui" class="transition-all duration-300">ç©å®¶ 4: <span id="s3">25000</span></div>
        </div>
    </div>

    <!-- ä¸­é–“å€åŸŸ -->
    <div id="preview-overlay" class="pointer-events-none fixed inset-0 flex flex-col items-center justify-center z-30 opacity-0 transition-opacity duration-200">
        <div class="bg-white/95 p-4 md:p-6 rounded-3xl border-4 border-yellow-600 backdrop-blur-md shadow-2xl flex flex-col items-center transform scale-75 md:scale-90 mb-2 md:mb-6 interactive-preview" 
             id="preview-box" onclick="game.confirmDiscardFromPreview()">
            <div id="preview-emoji" class="text-8xl md:text-[9rem] leading-none mb-2 filter drop-shadow-[0_5px_15px_rgba(0,0,0,0.3)]">ğŸ€„</div>
            <div id="preview-text" class="text-red-800 text-xl md:text-2xl font-black tracking-widest text-center whitespace-nowrap"></div>
            <div id="preview-sub" class="text-gray-600 text-xs md:text-sm mt-1 font-bold text-center"></div>
            <div id="preview-hint" class="text-green-600 text-xs mt-2 font-bold animate-pulse hidden">(é»æ“Šæ­¤è™•å‡ºç‰Œ)</div>
        </div>
        <div id="action-btns" class="flex flex-wrap justify-center gap-2 md:gap-3 hidden pointer-events-auto transform scale-90 md:scale-100 max-w-[90vw]">
            <button id="btn-chi" onclick="game.handlePlayerAction('chi')" class="btn-festive bg-green-600 text-white border-green-300">åƒ</button>
            <button id="btn-pon" onclick="game.handlePlayerAction('pon')" class="btn-festive bg-blue-600 text-white border-blue-300">ç¢°</button>
            <button id="btn-kan" onclick="game.handlePlayerAction('kan')" class="btn-festive bg-purple-600 text-white border-purple-300">æ§“</button>
            <button id="btn-hu" onclick="game.handlePlayerAction('hu')" class="btn-festive !bg-red-600 !text-white !border-white !shadow-[0_0_25px_rgba(220,38,38,0.8)]">èƒ¡</button>
            <button id="btn-skip" onclick="game.handlePlayerAction('skip')" class="btn-festive !bg-gray-700 !text-gray-200 !border-gray-500">é</button>
        </div>
        <div id="chi-select-btns" class="flex flex-wrap justify-center gap-4 hidden pointer-events-auto transform scale-90 md:scale-100 max-w-[95vw]"></div>
    </div>

    <div id="msg-box" class="pointer-events-none fixed top-[20%] left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-red-600 text-yellow-300 border-2 border-yellow-400 px-6 py-3 rounded-full font-black opacity-0 transition-all shadow-2xl scale-110 z-50 whitespace-nowrap text-sm md:text-base"></div>

    <div id="controls-area" class="absolute bottom-20 right-4 md:bottom-6 md:right-6 flex flex-col items-end z-20 gap-2">
        <button id="cam-toggle-btn" class="ctrl-btn active" onclick="game.toggleAutoCamera()" title="è‡ªå‹•è·Ÿéš¨è¦–è§’">ğŸ“¹</button>
        <button id="reset-cam-btn" class="ctrl-btn" onclick="game.resetCameraToCurrentPlayer()" title="é‡ç½®è¦–è§’">â†º</button>
    </div>

    <!-- åº•éƒ¨æ§åˆ¶ -->
    <div class="flex flex-col gap-2 md:gap-4 interactive pb-4 md:pb-8 pointer-events-none items-center w-full relative">
        <!-- è½ç‰Œæç¤ºå®¹å™¨ (æœƒå‹•æ…‹æ’å…¥åˆ°é€™è£¡) -->
        <div id="turn-indicator" class="pointer-events-auto text-center text-yellow-400 text-lg md:text-xl font-black drop-shadow-[0_2px_4px_rgba(0,0,0,0.8)] tracking-widest bg-black/40 py-2 rounded-lg px-6 backdrop-blur-sm mb-1 relative">
            ç­‰å¾…å‰æ™‚é–‹å±€...
        </div>
        <div id="hint-text" class="text-center text-yellow-500/80 text-xs md:text-sm font-bold drop-shadow-md tutorial-hint pointer-events-none">(å–®æŒ‡è½‰è¦–è§’ â€¢ é»æ“Šé¸ç‰Œ â€¢ é›™æ“Šå‡ºç‰Œ)</div>
    </div>
</div>

<!-- çµç®—è¦–çª— -->
<div id="result-overlay" class="fixed inset-0 hidden items-center justify-center bg-black/90 z-[100] p-6">
    <div class="max-w-sm w-full bg-red-950 border-4 border-yellow-500 rounded-3xl p-8 text-center text-white z-[101]">
        <h2 class="text-4xl font-black text-yellow-400 mb-4" id="result-title">å¤§å‰å¤§åˆ©ï¼</h2>
        <div class="text-xl mb-6 font-bold" id="result-winner"></div>
        <div class="flex flex-wrap justify-center gap-1 text-3xl mb-6 p-4 rounded-xl bg-white/10" id="result-hand"></div>
        <div class="text-2xl font-bold text-yellow-300 mb-8" id="result-coins"></div>
        <div class="flex flex-col gap-3">
            <button onclick="game.restartGame()" class="btn-festive w-full py-4 text-xl bg-green-600 border-green-400">å†ä¾†ä¸€å±€</button>
            <button onclick="game.showMenu()" class="btn-festive w-full py-3 text-lg bg-gray-600 border-gray-400">æ›´æ›æ¨¡å¼</button>
        </div>
    </div>
</div>

<!-- ä¸»é¸å–® -->
<div id="menu-overlay" class="fixed inset-0 bg-[#4a0404]/95 flex items-center justify-center z-50 p-4 md:p-6 text-white text-center backdrop-blur-md">
    <div class="max-w-md w-full border-4 border-[#d4af37] p-6 md:p-8 rounded-3xl bg-[#5a0505] shadow-[0_0_50px_rgba(0,0,0,0.8)] flex flex-col gap-4 md:gap-6">
        <div><h1 class="text-4xl md:text-5xl font-black mb-2 gold-text italic">æ­å–œç™¼è²¡</h1><h2 class="text-xl md:text-2xl font-bold text-yellow-100">å°æ—¥é›™åˆ¶ç«‹é«”éº»å°‡</h2></div>
        <div>
            <p class="mb-2 md:mb-3 text-yellow-500/80 font-medium uppercase tracking-widest text-xs">é¸æ“‡æ–°æ˜¥è¦å‰‡</p>
            <div class="flex gap-4 justify-center">
                <button id="rule-jp" onclick="selectRule('JP')" class="flex-1 py-3 rounded-xl border-2 border-white/20 bg-white/10 font-bold">æ—¥æœ¬éº»å°‡</button>
                <button id="rule-tw" onclick="selectRule('TW')" class="flex-1 py-3 rounded-xl border-2 border-white/20 bg-white/10 font-bold">è‡ºç£éº»å°‡</button>
            </div>
        </div>
        <div class="text-left">
            <p class="mb-2 md:mb-3 text-yellow-500/80 font-medium uppercase tracking-widest text-xs text-center">æ‹›ç‰ŒéŠç©æ¨¡å¼</p>
            <select id="player-mode" class="w-full p-3 md:p-4 bg-red-900/50 rounded-xl border border-yellow-600/50 text-base md:text-lg appearance-none text-center font-bold text-yellow-100 focus:outline-none focus:border-yellow-400 transition-colors">
                <option value="1h3c">1 ä½ç©å®¶ + 3 ä½é›»è…¦</option>
                <option value="3h1c" selected>3 ä½ç©å®¶ + 1 ä½é›»è…¦</option>
                <option value="4h">4 ä½çœŸäººå°æˆ°</option>
                <option value="2h2c">2 ä½ç©å®¶ + 2 ä½é›»è…¦</option>
            </select>
        </div>
        <button onclick="startGame()" class="w-full bg-gradient-to-r from-red-600 to-red-700 hover:from-red-500 hover:to-red-600 text-white py-4 md:py-5 rounded-2xl font-black text-2xl md:text-3xl shadow-[0_0_40px_rgba(212,175,55,0.4)] border-b-8 border-red-900 active:border-b-0 active:translate-y-2 transition-all">é–‹ å±€ è´ ç´… åŒ… <span class="text-sm block font-normal text-yellow-300 mt-1">(è²»ç”¨: 100 ä»£å¹£)</span></button>
        <p class="text-xs text-yellow-600">â€» éŸ³æ¨‚å°‡æ–¼é–‹å±€å¾Œè‡ªå‹•æ’­æ”¾ â€»</p>
        <p class="text-[10px] text-yellow-600/80 mt-1">Audio Source: Music by èƒ¤æ¨‚éŸ³æ¨‚</p>
    </div>
</div>

<script>
const TILE_EMOJI={'M1':'ğŸ€‡','M2':'ğŸ€ˆ','M3':'ğŸ€‰','M4':'ğŸ€Š','M5':'ğŸ€‹','M6':'ğŸ€Œ','M7':'ğŸ€','M8':'ğŸ€','M9':'ğŸ€','P1':'ğŸ€™','P2':'ğŸ€š','P3':'ğŸ€›','P4':'ğŸ€œ','P5':'ğŸ€','P6':'ğŸ€','P7':'ğŸ€Ÿ','P8':'ğŸ€ ','P9':'ğŸ€¡','S1':'ğŸ€','S2':'ğŸ€‘','S3':'ğŸ€’','S4':'ğŸ€“','S5':'ğŸ€”','S6':'ğŸ€•','S7':'ğŸ€–','S8':'ğŸ€—','S9':'ğŸ€˜','Z1':'ğŸ€€','Z2':'ğŸ€','Z3':'ğŸ€‚','Z4':'ğŸ€ƒ','Z5':'ğŸ€†','Z6':'ğŸ€…','Z7':'ğŸ€„','F1':'ğŸŒ¸','F2':'ğŸŒ¿','F3':'ğŸ‹','F4':'ğŸŒ¼','F5':'â˜€ï¸','F6':'ğŸŒ¬ï¸','F7':'ğŸ‚','F8':'â„ï¸'};
class Celebration{constructor(){this.canvas=document.getElementById('celebration-canvas');this.ctx=this.canvas.getContext('2d');this.particles=[];this.active=false;this.resize();window.addEventListener('resize',()=>this.resize());}resize(){this.canvas.width=window.innerWidth;this.canvas.height=window.innerHeight;}start(d=12000){this.active=true;this.particles=[];this.animate();for(let i=0;i<5;i++)this.fire();this.int=setInterval(()=>{if(this.active)this.fire()},500);this.conf=setInterval(()=>{if(this.active)this.addConf()},100);setTimeout(()=>this.stop(),d);}stop(){this.active=false;clearInterval(this.int);clearInterval(this.conf);this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);}fire(){const x=Math.random()*this.canvas.width,y=Math.random()*(this.canvas.height*0.5),c=`hsl(${Math.random()*360},100%,50%)`;for(let i=0;i<50;i++)this.particles.push({x,y,vx:(Math.random()-0.5)*10,vy:(Math.random()-0.5)*10,a:1,c,t:'f'});}addConf(){for(let i=0;i<5;i++)this.particles.push({x:Math.random()*this.canvas.width,y:-10,vx:(Math.random()-0.5)*2,vy:Math.random()*3+2,c:`hsl(${Math.random()*360},100%,50%)`,r:Math.random()*360,vr:(Math.random()-0.5)*10,t:'c'});}animate(){if(!this.active&&!this.particles.length)return;requestAnimationFrame(()=>this.animate());this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);for(let i=this.particles.length-1;i>=0;i--){const p=this.particles[i];if(p.t==='f'){p.x+=p.vx;p.y+=p.vy;p.vy+=0.05;p.a-=0.01;this.ctx.globalAlpha=p.a;this.ctx.fillStyle=p.c;this.ctx.beginPath();this.ctx.arc(p.x,p.y,3,0,Math.PI*2);this.ctx.fill();if(p.a<=0)this.particles.splice(i,1);}else{p.x+=p.vx;p.y+=p.vy;p.r+=p.vr;this.ctx.globalAlpha=1;this.ctx.fillStyle=p.c;this.ctx.save();this.ctx.translate(p.x,p.y);this.ctx.rotate(p.r*Math.PI/180);this.ctx.fillRect(-5,-3,10,6);this.ctx.restore();if(p.y>this.canvas.height)this.particles.splice(i,1);}}}}

class MahjongGame {
    constructor() {
        this.scene=null;this.camera=null;this.renderer=null;this.controls=null;
        this.mahjongGroup=new THREE.Group();this.labelsGroup=new THREE.Group();
        this.rule='TW';this.playerModes='3h1c';
        this.hands=[[],[],[],[]];this.melds=[[],[],[],[]];this.discards=[[],[],[],[]];this.flowers=[[],[],[],[]];
        this.wall=[];this.turn=0;this.credits=10000;
        this.isGameActive=false;this.waitingForAction=false;this.autoCamera=true;this.selectedTile=null;
        this.camConfigs=[{pos:new THREE.Vector3(0,24,18),target:new THREE.Vector3(0,-3,2)},{pos:new THREE.Vector3(18,24,0),target:new THREE.Vector3(2,-3,0)},{pos:new THREE.Vector3(0,24,-18),target:new THREE.Vector3(0,-3,-2)},{pos:new THREE.Vector3(-18,24,0),target:new THREE.Vector3(-2,-3,0)}];
        this.celebration=new Celebration();
    }
    init(){
        if(this.isInitialized)return;
        const c=document.getElementById('game-container');
        this.scene=new THREE.Scene();this.scene.background=new THREE.Color(0x1a0505);
        this.camera=new THREE.PerspectiveCamera(40,window.innerWidth/window.innerHeight,0.1,1000);
        this.renderer=new THREE.WebGLRenderer({antialias:true,logarithmicDepthBuffer:true});
        this.renderer.setSize(window.innerWidth,window.innerHeight);this.renderer.shadowMap.enabled=true;c.appendChild(this.renderer.domElement);
        this.controls=new THREE.OrbitControls(this.camera,this.renderer.domElement);
        this.controls.enableDamping=true;this.scene.add(new THREE.AmbientLight(0xffffff,0.9));
        const sun=new THREE.DirectionalLight(0xffffff,0.5);sun.position.set(5,20,10);this.scene.add(sun);
        const t=new THREE.Mesh(new THREE.BoxGeometry(24,1,24),new THREE.MeshPhongMaterial({color:0x8b0000}));t.position.y=-1;this.scene.add(t);
        const f=new THREE.Mesh(new THREE.BoxGeometry(25,0.8,25),new THREE.MeshPhongMaterial({color:0xd4af37}));f.position.y=-1.1;this.scene.add(f);
        this.scene.add(this.mahjongGroup);this.scene.add(this.labelsGroup);
        window.addEventListener('resize',()=>this.onResize());
        this.renderer.domElement.addEventListener('pointerup',(e)=>this.handleTap(e.clientX,e.clientY));
        this.animate();this.isInitialized=true;this.updateCreditUI();
    }
    onResize(){this.camera.aspect=window.innerWidth/window.innerHeight;this.camera.updateProjectionMatrix();this.renderer.setSize(window.innerWidth,window.innerHeight);this.celebration.resize();}
    toggleAutoCamera(){this.autoCamera=!this.autoCamera;document.getElementById('cam-toggle-btn').classList.toggle('active',this.autoCamera);if(this.autoCamera)this.resetCamera();}
    resetCamera(){const c=this.camConfigs[this.turn%4],p=c.pos.clone();if(window.innerWidth<window.innerHeight)p.multiplyScalar(1.5);new TWEEN.Tween(this.camera.position).to(p,800).easing(TWEEN.Easing.Quadratic.Out).start();new TWEEN.Tween(this.controls.target).to(c.target,800).easing(TWEEN.Easing.Quadratic.Out).start();}
    isComputer(p){return this.playerModes==='1h3c'?p!==0:(this.playerModes==='3h1c'?p===3:(this.playerModes==='2h2c'?p>=2:false));}
    
    setupGame(r,m){
        if(this.credits<100){alert("ä»£å¹£ä¸è¶³ï¼");this.showMenu();return;}
        this.updateCredits(-100); this.isGameActive=true;this.rule=r;this.playerModes=m;
        this.wall=[]; this.turn=0; this.waitingForAction=false;
        this.hands=[[],[],[],[]];this.melds=[[],[],[],[]];this.discards=[[],[],[],[]];this.flowers=[[],[],[],[]];
        
        let deck=[]; ['M','P','S'].forEach(s=>{for(let i=1;i<=9;i++)for(let k=0;k<4;k++)deck.push(s+i);});
        for(let i=1;i<=7;i++)for(let k=0;k<4;k++)deck.push('Z'+i);
        if(r==='TW')for(let i=1;i<=8;i++)deck.push('F'+i);
        // æ´—ç‰Œ (ç¢ºä¿ä¸é‡è¤‡)
        for(let i=deck.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[deck[i],deck[j]]=[deck[j],deck[i]];}
        this.wall=[...deck];

        const hs=r==='JP'?13:16;
        for(let p=0;p<4;p++) this.hands[p]=this.wall.splice(0,hs);
        if(r==='TW') this.handleFlower();
        for(let p=0;p<4;p++) this.hands[p].sort();

        this.controls.enableRotate=true;
        if(m==='1h3c'){this.controls.minAzimuthAngle=-Math.PI/4;this.controls.maxAzimuthAngle=Math.PI/4;document.getElementById('controls-area').classList.add('hidden-ctrl');}
        else{this.controls.minAzimuthAngle=-Infinity;this.controls.maxAzimuthAngle=Infinity;document.getElementById('controls-area').classList.remove('hidden-ctrl');}
        this.createLabels();this.renderTiles();this.resetCamera();this.nextTurn();
    }
    
    handleFlower(){
        let chg=true;
        while(chg){chg=false;for(let p=0;p<4;p++){for(let i=this.hands[p].length-1;i>=0;i--){if(this.hands[p][i].startsWith('F')){this.flowers[p].push(this.hands[p].splice(i,1)[0]);if(this.wall.length)this.hands[p].push(this.wall.pop());chg=true;}}}}
    }
    
    // æª¢æŸ¥è½ç‰Œ
    checkTenpai(hand, melds) {
        // ç°¡å–®é‚è¼¯ï¼šå˜—è©¦åŠ å…¥æ¯ä¸€å¼µå¯èƒ½çš„ç‰Œï¼Œçœ‹æ˜¯å¦èƒ¡ç‰Œ
        const testHand = [...hand];
        const suits = ['M','P','S','Z'];
        for(let s of suits) {
            const limit = s === 'Z' ? 7 : 9;
            for(let i=1; i<=limit; i++) {
                const tile = s + i;
                // æª¢æŸ¥æ˜¯å¦èƒ½èƒ¡
                if (this.checkWin([...testHand, tile])) return true;
            }
        }
        return false;
    }

    renderTiles(){
        this.mahjongGroup.clear(); if(this.selectedTile){this.hidePreview();this.selectedTile=null;}
        const tW=0.85,tH=1.25,tD=0.55, hSize=this.rule==='JP'?13:16;
        for(let p=0;p<4;p++){
            const hand=this.hands[p], hasDraw=hand.length>hSize+(this.melds[p].length*3)%3;
            const off=((hasDraw?hand.length-1:hand.length)*tW)/2;
            
            // è½ç‰Œæª¢æŸ¥ (åªå°çœŸäººé¡¯ç¤º)
            if(!this.isComputer(p) && this.checkTenpai(hand)) {
                 // é¡¯ç¤ºè½ç‰Œæ¨™ç±¤ï¼Œä½†è¦é¿å…é‡è¤‡
                 // é€™è£¡æˆ‘å€‘ç›´æ¥åœ¨UIå±¤åšä¸€å€‹æµ®å‹•æ¨™ç±¤
                 if(this.turn%4 === p) {
                    const existing = document.getElementById('tenpai-alert');
                    if(!existing) {
                        const alert = document.createElement('div');
                        alert.id = 'tenpai-alert';
                        alert.className = 'tenpai-alert';
                        alert.innerText = 'ğŸ”¥ è½ç‰Œä¸­ï¼';
                        document.getElementById('turn-indicator').appendChild(alert);
                    }
                 }
            } else {
                const existing = document.getElementById('tenpai-alert');
                if(existing) existing.remove();
            }

            hand.forEach((c,i)=>{
                const t=this.createTile(tW,tH,tD); let x=0,z=0,r=0,ip=(i*tW*1.02)-off;
                if(hasDraw&&i===hand.length-1) ip+=0.4;
                if(p===0){x=ip;z=9.5;r=0;}else if(p===1){x=9.5;z=ip;r=Math.PI/2;}else if(p===2){x=-ip;z=-9.5;r=Math.PI;}else if(p===3){x=-9.5;z=-ip;r=-Math.PI/2;}
                if(!this.isComputer(p)) this.addLabel(t,TILE_EMOJI[c],c);
                t.position.set(x,tH/2,z); t.rotation.y=r; t.userData={o:p,idx:i,c:c,t:'h'}; this.mahjongGroup.add(t);
            });
            let mSt=(hand.length*tW*1.02)/2+0.8;
            this.melds[p].forEach((m,mi)=>{m.forEach((c,ti)=>{const t=this.createTile(tW,tH,tD);this.addLabel(t,TILE_EMOJI[c],c);let x=0,z=0,r=0,mp=mSt+(mi*3+ti)*tW;if(p===0){x=mp;z=9.5;r=0;}else if(p===1){x=9.5;z=mp;r=Math.PI/2;}else if(p===2){x=-mp;z=-9.5;r=Math.PI;}else if(p===3){x=-9.5;z=-mp;r=-Math.PI/2;}t.position.set(x,tD/2,z);t.rotation.set(-Math.PI/2,0,r+Math.PI);this.mahjongGroup.add(t);});});
            [...this.flowers[p],...this.discards[p]].forEach((c,i)=>{const t=this.createTile(tW,tH,tD);this.addLabel(t,TILE_EMOJI[c],c);let x=0,z=0,r=0,rw=Math.floor(i/6),cl=i%6;if(p===0){x=(cl-2.5)*tW;z=2.5+rw*tH;r=0;}else if(p===1){x=2.5+rw*tH;z=(cl-2.5)*tW;r=-Math.PI/2;}else if(p===2){x=-(cl-2.5)*tW;z=-(2.5+rw*tH);r=Math.PI;}else if(p===3){x=-(2.5+rw*tH);z=-(cl-2.5)*tW;r=Math.PI/2;}t.position.set(x,tD/2,z);t.rotation.set(-Math.PI/2,0,r+Math.PI);this.mahjongGroup.add(t);});
        }
    }
    createTile(w,h,d){return new THREE.Mesh(new THREE.BoxGeometry(w,h,d),[new THREE.MeshPhongMaterial({color:0x228b22}),new THREE.MeshPhongMaterial({color:0x228b22}),new THREE.MeshPhongMaterial({color:0x228b22}),new THREE.MeshPhongMaterial({color:0x228b22}),new THREE.MeshPhongMaterial({color:0xffffff}),new THREE.MeshPhongMaterial({color:0x004d00})]);}
    addLabel(m,txt,c){const cvs=document.createElement('canvas');cvs.width=256;cvs.height=256;const ctx=cvs.getContext('2d');ctx.fillStyle='#fff';ctx.fillRect(0,0,256,256);ctx.fillStyle=(c.match(/^[M]|Z7/)||c.startsWith('F'))?'#c00':(c==='Z6'?'#080':'#000');ctx.font='bold 180px serif';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(txt,128,128);const l=new THREE.Mesh(new THREE.PlaneGeometry(0.8,1.2),new THREE.MeshBasicMaterial({map:new THREE.CanvasTexture(cvs),transparent:true,polygonOffset:true,polygonOffsetFactor:-2}));l.position.z=0.285;m.add(l);}
    createLabels(){this.labelsGroup.clear();[{x:0,z:12.5,r:0},{x:12.5,z:0,r:Math.PI/2},{x:0,z:-12.5,r:Math.PI},{x:-12.5,z:0,r:-Math.PI/2}].forEach((p,i)=>{const cvs=document.createElement('canvas');cvs.width=256;cvs.height=64;const ctx=cvs.getContext('2d');ctx.fillStyle=this.isComputer(i)?'#444':'#c00';ctx.fillRect(0,0,256,64);ctx.fillStyle='#fff';ctx.font='bold 36px sans-serif';ctx.textAlign='center';ctx.fillText((this.isComputer(i)?'é›»è…¦ ':'ç©å®¶ ')+(i+1),128,45);const m=new THREE.Mesh(new THREE.PlaneGeometry(5,1.2),new THREE.MeshBasicMaterial({map:new THREE.CanvasTexture(cvs),transparent:true}));m.position.set(p.x,0.1,p.z);m.rotation.set(-Math.PI/2,0,p.r);this.labelsGroup.add(m);});}
    
    nextTurn(){
        if(!this.isGameActive||this.waitingForAction)return;
        const p=this.turn%4, isC=this.isComputer(p);
        document.getElementById('turn-indicator').innerText=`ğŸ§§ è¼ªåˆ° ${isC?`é›»è…¦ ${p}`:`ç©å®¶ ${p+1}`} äº†`;
        if(this.autoCamera)this.resetCamera();
        this.updateUI();
        if(this.wall.length){
            const t=this.wall.shift();
            if(this.rule==='TW'&&t.startsWith('F'))this.handleDrawFlower(p,t);
            else{
                this.hands[p].push(t); this.renderTiles();
                // è‡ªæ‘¸æª¢æŸ¥
                if(this.checkWin(this.hands[p])){
                    if(!isC) this.trigAct(['hu'],t,p,true,p);
                    else { 
                        // é›»è…¦è‡ªæ‘¸
                        this.celebration.start();
                        this.showResult(p, 1000, `é›»è…¦ ${p} è‡ªæ‘¸èƒ¡ç‰Œï¼`);
                        this.updateCredits(-1000); // ç©å®¶è¼¸éŒ¢
                    }
                } else if(isC) setTimeout(()=>this.autoDiscard(p),1200);
            }
        }else this.showResult(-1,0,"æµå±€ï¼");
    }
    handleDrawFlower(p,t){this.flowers[p].push(t);this.showMessage("è£œèŠ±");this.renderTiles();setTimeout(()=>{if(this.wall.length){const n=this.wall.pop();if(n.startsWith('F'))this.handleDrawFlower(p,n);else{this.hands[p].push(n);this.renderTiles();if(this.isComputer(p))setTimeout(()=>this.autoDiscard(p),1200);}}},600);}
    autoDiscard(p){this.discardTile(p,Math.floor(Math.random()*this.hands[p].length));}
    discardTile(p,i){
        const t=this.hands[p].splice(i,1)[0]; this.hands[p].sort();
        // ä¿®æ­£ï¼šå¾æ‰‹ç‰Œç§»é™¤å¾Œï¼Œå¿…é ˆé‡æ–°æ¸²æŸ“ä¸€æ¬¡ä»¥æ¸…é™¤è¦–è¦ºæ®˜ç•™ï¼Œå†é¡¯ç¤ºç‰¹å¯«
        // ä½†ç‚ºäº†æµæš¢ï¼Œæˆ‘å€‘åœ¨ renderTiles è£¡å·²ç¶“å…¨æ¸…é‡å»ºï¼Œæ‰€ä»¥é‚è¼¯æ˜¯å®‰å…¨çš„
        this.discards[p].push(t); this.renderTiles();
        this.showFocus(t, this.isComputer(p)?`é›»è…¦ ${p}`:`ç©å®¶ ${p+1}`);
        let int=false;
        for(let i=0;i<4;i++){
            if(i!==p && !this.isComputer(i)){
                const acts=this.checkActs(t,p,i);
                if(acts.length){this.trigAct(acts,t,p,false,i);int=true;break;}
            } else if (i!==p && this.isComputer(i)) {
                 // é›»è…¦èƒ¡ç‰Œåˆ¤å®š (æ¦®èƒ¡)
                 if(this.checkWin([...this.hands[i], t])) {
                     this.celebration.start();
                     this.showResult(i, 500, `é›»è…¦ ${i} èƒ¡ç‰Œï¼`);
                     this.updateCredits(-500); // ç©å®¶è¼¸éŒ¢
                     int = true; break;
                 }
            }
        }
        if(!int){this.turn++;this.nextTurn();}
    }
    checkActs(t,f,to){
        const h=this.hands[to], a=[]; if(this.checkWin([...h,t]))a.push('hu');
        const s=h.filter(x=>x===t).length; if(s>=2)a.push('pon');if(s>=3)a.push('kan');
        if((f+1)%4===to && t.match(/^[MPS]/)){const n=parseInt(t[1]),su=t[0],hn=h.filter(x=>x.startsWith(su)).map(x=>parseInt(x[1]));if((hn.includes(n-1)&&hn.includes(n+1))||(hn.includes(n-2)&&hn.includes(n-1))||(hn.includes(n+1)&&hn.includes(n+2)))a.push('chi');}
        return a;
    }
    trigAct(a,t,f,sl,pi){
        this.waitingForAction=true; this.currentActionContext={tile:t,from:f,type:sl?'tsumo':'ron',pIdx:pi};
        document.getElementById('action-btns').classList.remove('hidden');
        ['chi','pon','kan','hu'].forEach(k=>{const b=document.getElementById(`btn-${k}`);b.disabled=!a.includes(k);b.classList.toggle('btn-hu-active',k==='hu'&&a.includes(k));});
        document.getElementById('preview-overlay').style.opacity='1';
    }
    handlePlayerAction(a){
        const c=this.currentActionContext; document.getElementById('action-btns').classList.add('hidden');document.getElementById('preview-overlay').style.opacity='0';document.getElementById('chi-select-btns').classList.add('hidden');this.waitingForAction=false;
        if(c.type==='tsumo'){if(a==='hu'){this.celebration.start();this.showResult(c.pIdx,1000,"è‡ªæ‘¸ï¼ç™¼è²¡ï¼");return;}}
        if(a==='skip'){this.showMessage("é");this.turn++;this.nextTurn();return;}
        if(a==='chi'){
            const h=this.hands[c.pIdx],t=c.tile,s=t[0],n=parseInt(t[1]),opts=[];
            if(h.includes(s+(n-2))&&h.includes(s+(n-1)))opts.push([s+(n-2),s+(n-1),t]);
            if(h.includes(s+(n-1))&&h.includes(s+(n+1)))opts.push([s+(n-1),t,s+(n+1)]);
            if(h.includes(s+(n+1))&&h.includes(s+(n+2)))opts.push([t,s+(n+1),s+(n+2)]);
            if(opts.length>1){this.showChiSel(opts,c.pIdx,t);return;}
            else if(opts.length===1){this.discards[c.from].pop();this.execChi(c.pIdx,opts[0],t);}
        } else {
            this.discards[c.from].pop(); this.execMeld(c.pIdx,a,c.tile);
        }
        if(a==='hu'){this.celebration.start();this.showResult(c.pIdx,500,"èƒ¡ç‰Œï¼");return;}
        if(a!=='chi'||(a==='chi'&&!this.waitingForAction)){this.finalize(c.pIdx);}
    }
    showChiSel(opts,pi,t){
        this.waitingForAction=true;const div=document.getElementById('chi-select-btns');div.innerHTML='';div.classList.remove('hidden');document.getElementById('action-btns').classList.add('hidden');document.getElementById('preview-overlay').style.opacity='1';
        opts.forEach(o=>{const b=document.createElement('button');b.className='btn-chi-select';b.innerText=o.sort().map(c=>TILE_EMOJI[c]).join('');b.onclick=()=>{div.classList.add('hidden');document.getElementById('preview-overlay').style.opacity='0';this.discards[this.currentActionContext.from].pop();this.execChi(pi,o,t);this.finalize(pi);};div.appendChild(b);});
    }
    execChi(p,tiles,tgt){const h=this.hands[p],rem=[...tiles];const ti=rem.indexOf(tgt);if(ti>-1)rem.splice(ti,1);rem.forEach(x=>{const i=h.indexOf(x);if(i>-1)h.splice(i,1);});this.melds[p].push(tiles.sort());}
    execMeld(p,t,tile){const h=this.hands[p],m=[tile];
        if(t==='pon')for(let i=0;i<2;i++){const idx=h.indexOf(tile);if(idx>-1)m.push(h.splice(idx,1)[0]);}
        else if(t==='kan')for(let i=0;i<3;i++){const idx=h.indexOf(tile);if(idx>-1)m.push(h.splice(idx,1)[0]);}
        this.melds[p].push(m.sort());
    }
    finalize(p){this.turn=p;this.renderTiles();this.updateUI();document.getElementById('turn-indicator').innerText=`è¼ªåˆ° ç©å®¶ ${p+1} å‡ºç‰Œ`;this.waitingForAction=false;this.currentActionContext=null;}
    confirmDiscardFromPreview(){if(this.selectedTile&&!this.waitingForAction&&this.isGameActive){const o=this.selectedTile.userData.o;if(o===(this.turn%4)&&!this.isComputer(o)){this.discardTile(o,this.selectedTile.userData.idx);this.clearSelection();}}}
    handleTap(x,y){
        if(!this.isGameActive || (this.waitingForAction && (!this.currentActionContext || this.currentActionContext.type!=='tsumo'))) return;
        const p=this.turn%4; if(this.isComputer(p)) return;
        this.mouse.x=(x/window.innerWidth)*2-1; this.mouse.y=-(y/window.innerHeight)*2+1;
        this.raycaster.setFromCamera(this.mouse,this.camera);
        const hits=this.raycaster.intersectObjects(this.mahjongGroup.children,true);
        if(hits.length){ let o=hits[0].object; while(o&&(!o.userData||o.userData.type!=='hand'))o=o.parent; if(o&&o.userData.o===p) this.onTileClick(o,p); } else this.clearSelection();
    }
    onTileClick(o,p){
        if(this.selectedTile===o){this.discardTile(p,o.userData.idx);this.clearSelection();if(this.currentActionContext&&this.currentActionContext.type==='tsumo'){document.getElementById('action-btns').classList.add('hidden');this.waitingForAction=false;this.currentActionContext=null;}}
        else{this.clearSelection();this.selectedTile=o;o.position.y+=0.8;o.scale.set(1.2,1.2,1.2);o.children.forEach(c=>{if(c.material)c.material.color.set(0xffffdd);});this.showPreview(o.userData.code);}
    }
    clearSelection(){if(this.selectedTile){this.selectedTile.position.y-=0.8;this.selectedTile.scale.set(1,1,1);this.selectedTile.children.forEach(c=>{if(c.material)c.material.color.set(0xffffff);});this.selectedTile=null;this.hidePreview();}}
    checkWin(h){const p=h.filter(x=>!x.startsWith('F')).sort();if(p.length%3!==2)return false;const c={};p.forEach(x=>c[x]=(c[x]||0)+1);let pr=0;for(let k in c)if(c[k]>=2)pr++;if(pr===7||pr===8)return true;const win=(cnt)=>{const ks=Object.keys(cnt).filter(k=>cnt[k]>0).sort();if(!ks.length)return true;const f=ks[0];if(cnt[f]>=3){const n={...cnt};n[f]-=3;if(win(n))return true;}if(f.match(/^[MPS]/)){const s=f[0],v=parseInt(f[1]),t2=s+(v+1),t3=s+(v+2);if(cnt[t2]&&cnt[t3]){const n={...cnt};n[f]--;n[t2]--;n[t3]--;if(win(n))return true;}}return false;};for(let k in c)if(c[k]>=2){const n={...c};n[k]-=2;if(win(n))return true;}return false;}
    showFocus(c,n){document.getElementById('preview-emoji').innerText=TILE_EMOJI[c];document.getElementById('preview-text').innerText=n+" æ‰“å‡º";document.getElementById('preview-sub').innerText="";document.getElementById('preview-hint').classList.add('hidden');document.getElementById('preview-overlay').style.opacity='1';if(!this.waitingForAction)setTimeout(()=>document.getElementById('preview-overlay').style.opacity='0',1200);}
    showPreview(c){document.getElementById('preview-emoji').innerText=TILE_EMOJI[c];document.getElementById('preview-text').innerText="å·²é¸å–";document.getElementById('preview-sub').innerText="å†æ¬¡é»æ“Šå‡ºç‰Œ";document.getElementById('preview-hint').classList.remove('hidden');document.getElementById('preview-overlay').style.opacity='1';}
    hidePreview(){document.getElementById('preview-overlay').style.opacity='0';}
    updateUI(){document.getElementById('mode-display').innerText=this.rule==='JP'?'æ—¥æœ¬éº»å°‡':'è‡ºç£éº»å°‡';document.getElementById('wall-count').innerText=this.wall.length;document.getElementById('credit-count').innerText=this.credits;for(let i=0;i<4;i++){const e=document.getElementById(`p${i}-ui`);if(e)e.style.color=(this.turn%4===i)?'#fbbf24':'#fff';}}
    showMessage(t){const b=document.getElementById('msg-box');b.innerText=t;b.style.opacity='1';setTimeout(()=>b.style.opacity='0',1500);}
    updateCredits(a){this.credits+=a;this.updateCreditUI();} updateCreditUI(){document.getElementById('credit-count').innerText=this.credits;}
    animate(){requestAnimationFrame(()=>this.animate());TWEEN.update();this.controls.update();this.renderer.render(this.scene,this.camera);}
    restartGame(){ this.setupGame(this.rule, this.playerModes); document.getElementById('result-overlay').style.display='none'; }
    showMenu(){ this.isGameActive=false; document.getElementById('result-overlay').style.display='none'; document.getElementById('menu-overlay').style.display='flex'; }
}

let game=new MahjongGame();
function selectRule(r){game.rule=r;document.getElementById('rule-jp').style.borderColor=r==='JP'?'#fbbf24':'#fff2';document.getElementById('rule-tw').style.borderColor=r==='TW'?'#fbbf24':'#fff2';}
function startGame(){document.getElementById('bgm').play().catch(()=>{});game.init();game.setupGame(game.rule,document.getElementById('player-mode').value);document.getElementById('menu-overlay').style.display='none';}
function returnToMenu(){game.showMenu();}
window.onload=()=>selectRule('TW');
</script>
</body>
</html>
