<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ–°æ˜¥å–œæ…¶ç‰ˆï¼šå°æ—¥é›™åˆ¶ç«‹é«”éº»å°‡</title>
    <!-- å¼•å…¥æ ¸å¿ƒåº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #2d0a0a; font-family: 'Microsoft JhengHei', 'Heiti TC', sans-serif; touch-action: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50; }
        .interactive { pointer-events: auto; }
        canvas { display: block; }
        
        #celebration-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 95; }

        /* æŒ‰éˆ•æ¨£å¼ï¼šå…¼é¡§è§¸æ§èˆ‡æ»‘é¼  */
        .btn-festive { 
            background: linear-gradient(135deg, #d4af37 0%, #aa8a2e 100%); 
            color: #4a0404; border-radius: 16px; font-weight: 900; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: 2px solid #fff5d7; text-shadow: 0 1px 0 rgba(255,255,255,0.3);
            padding: 12px 20px; font-size: 1.2rem; min-width: 85px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
        }
        @media (min-width: 768px) { 
            .btn-festive { padding: 12px 30px; font-size: 1.4rem; min-width: 100px; } 
            .btn-festive:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4); filter: brightness(1.1); }
        }
        .btn-festive:active { transform: scale(0.95) translateY(0); }
        .btn-festive:disabled { filter: grayscale(1); opacity: 0.5; pointer-events: none; transform: none; }
        
        .btn-hu-active {
            animation: pulse-gold 1.5s infinite;
            background: linear-gradient(135deg, #ff0000 0%, #990000 100%) !important;
            color: white !important; border-color: #ffd700 !important;
            box-shadow: 0 0 25px #ff0000 !important; transform: scale(1.05);
        }
        @keyframes pulse-gold { 
            0% { box-shadow: 0 0 5px #ffd700; transform: scale(1.05); } 
            50% { box-shadow: 0 0 25px #ffd700; transform: scale(1.1); } 
            100% { box-shadow: 0 0 5px #ffd700; transform: scale(1.05); } 
        }

        .red-panel { background: rgba(80, 0, 0, 0.85); border: 2px solid #d4af37; box-shadow: 0 4px 20px rgba(0,0,0,0.6); backdrop-filter: blur(5px); }
        
        .tenpai-alert {
            position: absolute; top: -50px; left: 50%; transform: translateX(-50%);
            background: #ef4444; color: #fff; font-weight: 900;
            padding: 6px 20px; border-radius: 20px; border: 2px solid #fcd34d;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.8);
            animation: bounce 0.8s infinite; pointer-events: none; white-space: nowrap; z-index: 60;
        }
        @keyframes bounce { 0%, 100% { transform: translateX(-50%) translateY(0); } 50% { transform: translateX(-50%) translateY(-10px); } }

        .ctrl-btn {
            background: rgba(0,0,0,0.6); border: 2px solid #d4af37; color: #d4af37;
            border-radius: 50%; width: 50px; height: 50px; font-size: 24px;
            display: flex; align-items: center; justify-content: center;
            pointer-events: auto; cursor: pointer; transition: 0.3s;
            backdrop-filter: blur(4px);
        }
        @media (min-width: 1024px) { .ctrl-btn { width: 60px; height: 60px; font-size: 28px; } .ctrl-btn:hover { background: rgba(212, 175, 55, 0.3); } }
        .ctrl-btn:active { transform: scale(0.9); }
        .ctrl-btn.active { background: #d4af37; color: #000; box-shadow: 0 0 15px #d4af37; }

        .btn-chi-select {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: 2px solid #6ee7b7; color: white; padding: 12px 24px; border-radius: 16px; font-size: 2rem;
            display: flex; gap: 5px; box-shadow: 0 6px 15px rgba(0,0,0,0.6); cursor: pointer;
        }
        .btn-chi-select:hover { transform: translateY(-3px); }
        .btn-chi-select:active { transform: scale(0.95); }

        .btn-exit {
            background: linear-gradient(135deg, #c0392b 0%, #8e44ad 100%);
            color: white; border: 2px solid #e74c3c; border-radius: 50px; 
            font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            display: flex; align-items: center; gap: 5px; padding: 8px 16px; font-size: 0.95rem;
            cursor: pointer;
        }
        .btn-exit:hover { filter: brightness(1.1); }
        .btn-exit:active { transform: scale(0.95); }

        /* é è¦½è¦–çª—å„ªåŒ– */
        #preview-box { background: rgba(255,255,255,0.95); }
        #preview-box.interactive-preview { cursor: pointer; pointer-events: auto; transition: transform 0.1s ease; }
        #preview-box.interactive-preview:hover { transform: scale(1.02); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        #preview-box.interactive-preview:active { transform: scale(0.95); }
        .preview-anim { animation: popIn 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        .deduct-anim { position: absolute; color: #ff4d4d; font-weight: bold; animation: fadeUp 1s forwards; pointer-events: none; font-size: 1.2rem; text-shadow: 0 0 3px white; }
        @keyframes fadeUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-30px); } }
        
        .hidden-ctrl { display: none !important; }
        
        /* é¸å–®è¦å‰‡æŒ‰éˆ•æ¨£å¼ */
        .rule-btn-active { border-color: #fcd34d !important; background-color: rgba(185, 28, 28, 0.8) !important; color: #fcd34d !important; box-shadow: 0 0 15px rgba(252, 211, 77, 0.4); }
        .rule-btn-inactive { border-color: rgba(255,255,255,0.2) !important; background-color: rgba(255,255,255,0.05) !important; color: rgba(255,255,255,0.6) !important; }

        /* æ¡Œé¢ç‰ˆ/æ©«ç‰ˆç‰¹åˆ¥å„ªåŒ– */
        @media (min-width: 1024px) {
            #ui-layer { padding: 1.5rem; }
            #preview-box { min-width: 320px; }
            #score-board { min-width: auto; }
        }
        
        /* é¿å…æ©«å±æ‰‹æ©Ÿæ™‚ UI é®æ“‹å¤ªå¤š */
        @media (max-height: 500px) and (orientation: landscape) {
            #game-info-panel { padding: 4px 8px; font-size: 0.75rem; }
            .btn-festive { padding: 8px 16px; font-size: 1rem; min-height: auto; }
            #preview-emoji { font-size: 4rem; margin: 0; }
            #preview-box { padding: 0.5rem 1rem; margin-bottom: 2px; }
            .btn-exit { padding: 4px 10px; font-size: 0.8rem; }
        }
    </style>
</head>
<body>

<div id="game-container"></div>
<canvas id="celebration-canvas"></canvas>

<audio id="bgm" loop>
    <source src="https://raw.githubusercontent.com/cendre-lgtm/2026/refs/heads/main/(%E6%AD%A1%E5%BF%AB)%20%E6%96%B0%E5%B9%B4%EF%BD%9C%E5%85%8D%E8%B2%BB%E8%83%8C%E6%99%AF%E9%9F%B3%E6%A8%82%E4%B8%8B%E8%BC%89%EF%BD%9C%E7%84%A1%E7%89%88%E6%AC%8A%E9%85%8D%E6%A8%82%EF%BD%9CBGM%EF%BD%9CNCS%20%E3%80%90%E8%83%A4%E6%A8%82%E9%9F%B3%E6%A8%82%E3%80%91%20(7).mp3" type="audio/mpeg">
</audio>

<div id="ui-layer" class="flex flex-col justify-between p-2 md:p-4 h-full pointer-events-none">
    <!-- é ‚éƒ¨è³‡è¨Šï¼šæ¡Œé¢ç‰ˆæ©«å‘æ’åˆ—ï¼Œæ‰‹æ©Ÿç‰ˆç¸±å‘ä½†ç·Šæ¹Š -->
    <div class="flex justify-between items-start w-full pointer-events-none">
        <div class="flex flex-col gap-2 items-start max-w-[45%] lg:max-w-[30%] pointer-events-auto">
            <button onclick="game.showMenu()" class="btn-exit shadow-md hover:shadow-lg transition-all">
                <span class="text-lg">ğŸ </span> <span class="hidden md:inline">å›ä¸»é¸å–®</span><span class="md:hidden">é¸å–®</span>
            </button>
            <div id="game-info-panel" class="red-panel text-white p-3 rounded-xl text-xs md:text-sm lg:text-base shadow-lg w-full relative transition-all">
                <div class="flex items-center justify-between mb-1">
                    <div class="flex items-center gap-1">
                        <span class="text-yellow-400 font-bold text-lg">ğŸ’°</span>
                        <span id="credit-display" class="font-mono font-bold text-xl text-yellow-100">10000</span>
                    </div>
                </div>
                <div class="h-[1px] bg-white/20 my-1"></div>
                <div class="flex justify-between items-center gap-2">
                    <div class="truncate opacity-90"><span id="mode-text" class="text-yellow-300 font-bold">-</span></div>
                    <div class="font-mono text-yellow-200">å‰©é¤˜:<span id="wall-text" class="font-bold ml-1 text-white">--</span></div>
                </div>
            </div>
        </div>
        
        <!-- ç©åˆ†æ¿ï¼šæ‰‹æ©Ÿç‰ˆç·Šæ¹Šæ ¼ç‹€ï¼Œæ¡Œé¢ç‰ˆæ©«å‘å±•é–‹ -->
        <div id="score-board" class="red-panel text-white p-2 md:p-4 rounded-xl text-xs md:text-sm lg:text-base shadow-lg min-w-[35%] lg:min-w-auto lg:flex lg:gap-6 lg:items-center pointer-events-auto">
            <div class="grid grid-cols-1 gap-1 lg:flex lg:gap-6">
                <div id="p0-ui" class="transition-all duration-300 p-1 lg:px-3 rounded">ç©å®¶ 1: <span id="s0" class="font-mono">25000</span></div>
                <div id="p1-ui" class="transition-all duration-300 p-1 lg:px-3 rounded">ç©å®¶ 2: <span id="s1" class="font-mono">25000</span></div>
                <div id="p2-ui" class="transition-all duration-300 p-1 lg:px-3 rounded">ç©å®¶ 3: <span id="s2" class="font-mono">25000</span></div>
                <div id="p3-ui" class="transition-all duration-300 p-1 lg:px-3 rounded">ç©å®¶ 4: <span id="s3" class="font-mono">25000</span></div>
            </div>
        </div>
    </div>

    <!-- é è¦½èˆ‡æ“ä½œå€ -->
    <div id="preview-overlay" class="pointer-events-none fixed inset-0 flex flex-col items-center justify-center z-50 opacity-0 transition-opacity duration-200">
        <!-- é è¦½ç‰Œå¡ -->
        <div class="bg-white/95 p-4 md:p-8 rounded-3xl border-4 border-yellow-600 shadow-2xl flex flex-col items-center mb-4 md:mb-8 interactive transform transition-transform scale-90 md:scale-100 backdrop-blur-sm" id="preview-box" onclick="game.confirmDiscardFromPreview()">
            <div id="preview-emoji" class="text-8xl md:text-[9rem] lg:text-[10rem] leading-none mb-2 mt-2 select-none">ğŸ€„</div>
            <div id="preview-text" class="text-red-900 text-2xl md:text-3xl font-black"></div>
            <div id="preview-sub" class="text-gray-500 font-bold text-sm md:text-base mt-1"></div>
            <div id="preview-hint" class="text-green-700 text-sm md:text-base mt-3 font-bold animate-bounce hidden bg-green-100 px-4 py-1 rounded-full shadow-sm">
                <span class="hidden lg:inline">æŒ‰ç©ºç™½éµæˆ–</span>å†æ¬¡é»æ“Šå‡ºç‰Œ
            </div>
        </div>
        
        <!-- æ“ä½œæŒ‰éˆ•ç¾¤ -->
        <div id="action-btns" class="flex flex-wrap justify-center gap-3 md:gap-4 hidden pointer-events-auto px-4 max-w-lg w-full">
            <button id="btn-chi" onclick="game.handlePlayerAction('chi')" class="btn-festive !bg-emerald-700 !text-white flex-1 hover:!bg-emerald-600">åƒ</button>
            <button id="btn-pon" onclick="game.handlePlayerAction('pon')" class="btn-festive !bg-sky-700 !text-white flex-1 hover:!bg-sky-600">ç¢°</button>
            <button id="btn-kan" onclick="game.handlePlayerAction('kan')" class="btn-festive !bg-indigo-700 !text-white flex-1 hover:!bg-indigo-600">æ§“</button>
            <button id="btn-hu" onclick="game.handlePlayerAction('hu')" class="btn-festive btn-hu-active flex-[1.5]">èƒ¡</button>
            <button id="btn-skip" onclick="game.handlePlayerAction('skip')" class="btn-festive !bg-slate-600 !text-white flex-[0.8] hover:!bg-slate-500">é</button>
        </div>
        
        <!-- åƒç‰Œé¸æ“‡å€ -->
        <div id="chi-select-btns" class="flex flex-wrap justify-center gap-4 hidden pointer-events-auto pb-20"></div>
    </div>

    <div id="msg-box" class="fixed top-[20%] left-1/2 -translate-x-1/2 bg-gradient-to-r from-red-600 to-red-800 text-white px-8 py-4 rounded-2xl font-black opacity-0 transition-all z-[60] text-xl lg:text-3xl shadow-2xl border-2 border-yellow-400 pointer-events-none whitespace-nowrap scale-90 lg:scale-100"></div>

    <!-- å³ä¸‹è§’æ§åˆ¶ -->
    <div id="controls-area" class="absolute bottom-24 lg:bottom-32 right-4 flex flex-col gap-3 interactive z-40">
        <button id="cam-toggle-btn" class="ctrl-btn active" onclick="game.toggleAutoCamera()" title="è‡ªå‹•è·Ÿéš¨">ğŸ“¹</button>
        <button class="ctrl-btn" onclick="game.resetCameraToCurrentPlayer()" title="é‡ç½®è¦–è§’">â†º</button>
    </div>

    <!-- åº•éƒ¨ç‹€æ…‹ -->
    <div class="flex flex-col items-center pb-6 lg:pb-10 w-full pointer-events-none">
        <div id="turn-indicator" class="bg-black/70 text-yellow-400 px-8 py-3 rounded-full font-bold text-xl lg:text-2xl mb-2 relative backdrop-blur-sm border border-yellow-500/30 shadow-lg transition-all">
            ç­‰å¾…å‰æ™‚...
        </div>
        <div class="text-white/60 text-xs lg:text-sm font-bold tracking-wider bg-black/30 px-4 py-1.5 rounded-full backdrop-blur-sm">
            <span class="md:hidden">å–®æŒ‡æ—‹è½‰ â€¢ é»æ“Šé¸ç‰Œ</span>
            <span class="hidden md:inline">æ»‘é¼ æ‹–æ›³æ—‹è½‰ â€¢ é»æ“Šé¸ç‰Œ â€¢ ç©ºç™½éµå‡ºç‰Œ</span>
        </div>
    </div>
</div>

<!-- çµç®—è¦–çª— -->
<div id="result-overlay" class="fixed inset-0 hidden items-center justify-center bg-black/90 z-[100] p-4 backdrop-blur-md">
    <div class="max-w-md w-full bg-gradient-to-b from-red-900 to-red-950 border-4 border-yellow-500 rounded-3xl p-6 lg:p-10 text-center text-white shadow-2xl transform transition-all scale-100">
        <h2 class="text-5xl lg:text-6xl font-black text-yellow-400 mb-2 drop-shadow-md tracking-wider" id="result-title">å¤§å‰å¤§åˆ©</h2>
        <div class="text-xl lg:text-2xl mb-6 font-bold text-yellow-100" id="result-winner"></div>
        <div class="flex flex-wrap justify-center gap-1 text-4xl lg:text-5xl mb-6 p-4 rounded-xl bg-black/30 min-h-[80px] items-center shadow-inner" id="result-hand"></div>
        <div class="text-3xl lg:text-4xl font-bold text-yellow-300 mb-8 bg-black/20 py-3 rounded-lg" id="result-coins"></div>
        <div class="flex flex-col gap-3">
            <button onclick="game.restartCurrent()" class="btn-festive w-full py-4 text-xl !bg-green-700 hover:!bg-green-600">ç¹¼çºŒæŒ‘æˆ°</button>
            <button onclick="game.showMenu()" class="btn-festive w-full py-4 text-xl !bg-slate-700 hover:!bg-slate-600">æ›´æ›æ¨¡å¼</button>
        </div>
    </div>
</div>

<!-- ä¸»é¸å–® -->
<div id="menu-overlay" class="fixed inset-0 bg-[url('https://images.unsplash.com/photo-1549887534-1541e9326642?q=80&w=1000&auto=format&fit=crop')] bg-cover bg-center flex items-center justify-center z-[100] p-4 text-white text-center">
    <div class="absolute inset-0 bg-red-950/90 backdrop-blur-sm"></div>
    <div class="relative max-w-md w-full border-4 border-[#d4af37] p-6 md:p-8 rounded-3xl bg-red-900/95 shadow-2xl flex flex-col gap-6">
        <div>
            <h1 class="text-6xl lg:text-7xl font-black gold-text italic tracking-tighter drop-shadow-lg">æ–°æ˜¥éº»å°‡</h1>
            <p class="text-yellow-200 font-bold mt-2 text-lg lg:text-xl tracking-widest">ğŸ§§ é›™è¦å‰‡ 3D ç«¶æŠ€ ğŸ§§</p>
        </div>
        
        <div class="space-y-2">
            <label class="text-yellow-100 font-bold text-sm block text-left ml-1">é¸æ“‡è¦å‰‡ï¼š</label>
            <div class="flex gap-4">
                <button id="menu-rule-tw" onclick="selectRule('TW')" class="rule-btn-active flex-1 py-4 rounded-xl border-2 font-black text-xl transition-all hover:brightness-110">è‡ºç£éº»å°‡</button>
                <button id="menu-rule-jp" onclick="selectRule('JP')" class="rule-btn-inactive flex-1 py-4 rounded-xl border-2 font-black text-xl transition-all hover:brightness-110">æ—¥æœ¬éº»å°‡</button>
            </div>
        </div>

        <div class="space-y-2">
            <label class="text-yellow-100 font-bold text-sm block text-left ml-1">å°æˆ°æ¨¡å¼ï¼š</label>
            <select id="player-mode-select" class="w-full p-4 bg-black/40 rounded-xl border-2 border-yellow-600/50 font-bold text-yellow-100 text-lg outline-none focus:border-yellow-400 cursor-pointer hover:bg-black/50 transition-colors">
                <option value="3h1c">1 çœŸäºº + 3 é›»è…¦ (å–®äºº)</option>
                <option value="1h3c">3 çœŸäºº + 1 é›»è…¦</option>
                <option value="2h2c">2 çœŸäºº + 2 é›»è…¦</option>
                <option value="4h">4 çœŸäººåŒæ©Ÿå°æˆ° (æ´¾å°)</option>
            </select>
        </div>

        <button onclick="startGame()" class="w-full bg-gradient-to-r from-red-600 to-red-700 py-5 rounded-2xl font-black text-3xl shadow-xl border-b-8 border-red-800 active:border-b-0 active:translate-y-2 transition-all mt-2 group relative overflow-hidden">
            <span class="relative z-10">é–‹ å±€ è´ ç´… åŒ…</span>
            <div class="absolute inset-0 bg-white/20 transform -skew-x-12 -translate-x-full group-hover:animate-shine"></div>
            <span class="text-sm block font-normal text-yellow-300 mt-1 opacity-80 group-hover:opacity-100">(è²»ç”¨: 100 ä»£å¹£)</span>
        </button>
        <p class="text-[10px] text-yellow-500/50 mt-2">Mobile Optimized â€¢ 3D WebGL â€¢ Responsive</p>
    </div>
</div>

<script>
// --- å…¨åŸŸå¸¸é‡ ---
const TILE_EMOJI={'M1':'ğŸ€‡','M2':'ğŸ€ˆ','M3':'ğŸ€‰','M4':'ğŸ€Š','M5':'ğŸ€‹','M6':'ğŸ€Œ','M7':'ğŸ€','M8':'ğŸ€','M9':'ğŸ€','P1':'ğŸ€™','P2':'ğŸ€š','P3':'ğŸ€›','P4':'ğŸ€œ','P5':'ğŸ€','P6':'ğŸ€','P7':'ğŸ€Ÿ','P8':'ğŸ€ ','P9':'ğŸ€¡','S1':'ğŸ€','S2':'ğŸ€‘','S3':'ğŸ€’','S4':'ğŸ€“','S5':'ğŸ€”','S6':'ğŸ€•','S7':'ğŸ€–','S8':'ğŸ€—','S9':'ğŸ€˜','Z1':'ğŸ€€','Z2':'ğŸ€','Z3':'ğŸ€‚','Z4':'ğŸ€ƒ','Z5':'ğŸ€†','Z6':'ğŸ€…','Z7':'ğŸ€„','F1':'ğŸŒ¸','F2':'ğŸŒ¿','F3':'ğŸ‹','F4':'ğŸŒ¼','F5':'â˜€ï¸','F6':'ğŸŒ¬ï¸','F7':'ğŸ‚','F8':'â„ï¸'};

// --- æ…¶ç¥ç‰¹æ•ˆ ---
class CelebrationSystem {
    constructor() {
        this.canvas = document.getElementById('celebration-canvas');
        this.ctx = this.canvas.getContext('2d');
        this.particles = []; this.active = false;
        window.addEventListener('resize', () => { this.canvas.width = window.innerWidth; this.canvas.height = window.innerHeight; });
        this.canvas.width = window.innerWidth; this.canvas.height = window.innerHeight;
    }
    start(dur = 8000) {
        this.active = true; this.particles = []; this.animate();
        this.fireInt = setInterval(() => { if(this.active) this.spawnFirework(); }, 600);
        this.confInt = setInterval(() => { if(this.active) this.spawnConfetti(); }, 150);
        setTimeout(() => this.stop(), dur);
    }
    stop() { this.active = false; clearInterval(this.fireInt); clearInterval(this.confInt); this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height); }
    spawnFirework() {
        const x = Math.random()*this.canvas.width, y = Math.random()*(this.canvas.height*0.5);
        const color = `hsl(${Math.random()*360},100%,60%)`;
        for(let i=0; i<40; i++) this.particles.push({x, y, vx:(Math.random()-0.5)*12, vy:(Math.random()-0.5)*12, alpha:1, color, type:'f'});
    }
    spawnConfetti() {
        for(let i=0; i<6; i++) this.particles.push({x:Math.random()*this.canvas.width, y:-20, vx:(Math.random()-0.5)*3, vy:Math.random()*3+3, rotation:Math.random()*360, vr:(Math.random()-0.5)*15, color:`hsl(${Math.random()*360},80%,60%)`, type:'c'});
    }
    animate() {
        if(!this.active && !this.particles.length) return;
        requestAnimationFrame(()=>this.animate());
        this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);
        for(let i=this.particles.length-1; i>=0; i--){
            const p = this.particles[i];
            if(p.type === 'f'){
                p.x+=p.vx; p.y+=p.vy; p.vy+=0.1; p.alpha-=0.02;
                this.ctx.globalAlpha = Math.max(0, p.alpha); this.ctx.fillStyle = p.color;
                this.ctx.beginPath(); this.ctx.arc(p.x, p.y, 3, 0, Math.PI*2); this.ctx.fill();
                if(p.alpha<=0) this.particles.splice(i,1);
            } else {
                p.x+=p.vx; p.y+=p.vy; p.rotation+=p.vr;
                this.ctx.globalAlpha = 1; this.ctx.fillStyle = p.color;
                this.ctx.save(); this.ctx.translate(p.x, p.y); this.ctx.rotate(p.rotation*Math.PI/180); this.ctx.fillRect(-6,-4,12,8); this.ctx.restore();
                if(p.y > this.canvas.height) this.particles.splice(i,1);
            }
        }
    }
}

// --- éŠæˆ²æ ¸å¿ƒ ---
class MahjongGame {
    constructor() {
        this.credits = 10000;
        this.rule = 'TW';
        this.playerModes = '3h1c';
        this.turn = 0;
        this.wall = [];
        this.hands = [[],[],[],[]];
        this.discards = [[],[],[],[]];
        this.melds = [[],[],[],[]];
        this.flowers = [[],[],[],[]];
        this.scores = [25000, 25000, 25000, 25000];
        
        this.scene = null; this.camera = null; this.renderer = null; this.controls = null;
        this.mahjongGroup = new THREE.Group();
        this.labelsGroup = new THREE.Group();
        this.raycaster = new THREE.Raycaster();
        this.mouse = new THREE.Vector2();
        this.pointerDownPos = new THREE.Vector2();
        this.pointerDownTime = 0;
        
        this.isInitialized = false;
        this.isGameActive = false;
        this.autoDiscardTimeout = null;
        this.waitingForAction = false;
        this.currentActionContext = null; 
        this.autoCamera = true;
        this.selectedTile = null;
        this.celebration = new CelebrationSystem();

        this.camConfigs = [
            {pos:new THREE.Vector3(0,26,20), target:new THREE.Vector3(0,-4,2)},
            {pos:new THREE.Vector3(20,26,0), target:new THREE.Vector3(2,-4,0)},
            {pos:new THREE.Vector3(0,26,-20), target:new THREE.Vector3(0,-4,-2)},
            {pos:new THREE.Vector3(-20,26,0), target:new THREE.Vector3(-2,-4,0)}
        ];
        this.tilesObjects = [];
        
        // ç¶å®šéµç›¤äº‹ä»¶
        window.addEventListener('keydown', (e) => this.onKeyDown(e));
        // ç¶å®šæ»‘é¼ ç§»å‹•äº‹ä»¶ (æ¡Œé¢ç‰ˆæ‡¸åœæ•ˆæœ)
        window.addEventListener('mousemove', (e) => this.onMouseMove(e));
    }

    init() {
        if(this.isInitialized) return;
        const container = document.getElementById('game-container');
        this.scene = new THREE.Scene();
        this.scene.background = new THREE.Color(0x2d0a0a);
        
        // èª¿æ•´ç›¸æ©Ÿè¦–è§’ï¼Œæ›´é©åˆç§»å‹•ç«¯
        this.camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000);
        this.renderer = new THREE.WebGLRenderer({ antialias: true, logarithmicDepthBuffer: true });
        this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // å„ªåŒ–æ€§èƒ½
        this.renderer.setSize(window.innerWidth, window.innerHeight);
        this.renderer.shadowMap.enabled = true;
        container.appendChild(this.renderer.domElement);

        this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement);
        this.controls.enableDamping = true;
        this.controls.dampingFactor = 0.05;
        this.controls.maxPolarAngle = Math.PI/2.1;
        this.controls.enablePan = false; // ç¦æ­¢å¹³ç§»ï¼Œé˜²æ­¢è¿·å¤±
        this.controls.minDistance = 10;
        this.controls.maxDistance = 60;

        this.scene.add(new THREE.AmbientLight(0xffffff, 0.8));
        const sun = new THREE.DirectionalLight(0xffffff, 0.6);
        sun.position.set(10, 30, 20);
        sun.castShadow = true;
        this.scene.add(sun);

        // æ¡Œé¢è²¼åœ–
        const table = new THREE.Mesh(new THREE.BoxGeometry(26,1,26), new THREE.MeshPhongMaterial({color:0x8b0000}));
        table.position.y = -1;
        this.scene.add(table);
        
        // è£é£¾é‚Šæ¡†
        const border = new THREE.Mesh(new THREE.BoxGeometry(27,0.8,27), new THREE.MeshBasicMaterial({color:0xd4af37}));
        border.position.y = -1.1;
        this.scene.add(border);

        this.scene.add(this.mahjongGroup);
        this.scene.add(this.labelsGroup);

        window.addEventListener('resize', () => this.onResize());
        
        // çµ±ä¸€è™•ç†æ»‘é¼ èˆ‡è§¸æ§çš„é»æ“Š
        const canvas = this.renderer.domElement;
        canvas.addEventListener('pointerdown', (e) => this.onPointerDown(e));
        canvas.addEventListener('pointerup', (e) => this.onPointerUp(e));

        this.isInitialized = true;
        this.animate();
        this.updateCreditUI();
    }

    onResize() {
        this.camera.aspect = window.innerWidth/window.innerHeight;
        this.camera.updateProjectionMatrix();
        this.renderer.setSize(window.innerWidth, window.innerHeight);
        // å¦‚æœæ˜¯éŠæˆ²ä¸­åˆ‡æ›æ©«ç›´å±ï¼Œèª¿æ•´ç›¸æ©Ÿä½ç½®
        if(this.isGameActive && this.autoCamera) {
            this.resetCameraToCurrentPlayer();
        }
    }
    
    // --- ä¿®å¾©ï¼šæ–°å¢ animate å‡½æ•¸ ---
    animate() {
        requestAnimationFrame(() => this.animate());
        TWEEN.update();
        if (this.controls) this.controls.update();
        if (this.renderer && this.scene && this.camera) {
            this.renderer.render(this.scene, this.camera);
        }
    }

    toggleAutoCamera() {
        this.autoCamera = !this.autoCamera;
        document.getElementById('cam-toggle-btn').classList.toggle('active', this.autoCamera);
        if(this.autoCamera) this.resetCameraToCurrentPlayer();
    }

    resetCameraToCurrentPlayer() {
        const config = this.camConfigs[this.turn % 4];
        const finalPos = config.pos.clone();
        
        // éŸ¿æ‡‰å¼ç›¸æ©Ÿèª¿æ•´ï¼šæ ¹æ“šé•·å¯¬æ¯”è‡ªå‹•ç¸®æ”¾
        const aspect = window.innerWidth / window.innerHeight;
        let zoomFactor = 1.0;
        
        if(aspect < 0.6) { // æ‰‹æ©Ÿç›´å‘ (å¾ˆçª„)
            zoomFactor = 1.4; 
        } else if (aspect < 1.0) { // å¹³æ¿ç›´å‘
            zoomFactor = 1.2;
        } else if (aspect < 1.5) { // å‚³çµ±æ©«å‘
            zoomFactor = 1.0;
        } else { // å¯¬è¢å¹•/æ‰‹æ©Ÿæ©«å‘
            zoomFactor = 0.9;
        }
        
        finalPos.multiplyScalar(zoomFactor);
        
        new TWEEN.Tween(this.camera.position).to(finalPos, 800).easing(TWEEN.Easing.Quadratic.Out).start();
        new TWEEN.Tween(this.controls.target).to(config.target, 800).easing(TWEEN.Easing.Quadratic.Out).start();
    }

    isComputer(p) {
        if(this.playerModes==='1h3c') return p!==0; // 0æ˜¯äººï¼Œå…¶ä»–é›»è…¦
        if(this.playerModes==='3h1c') return p===3; // 3æ˜¯é›»è…¦
        if(this.playerModes==='2h2c') return p>=2;
        if(this.playerModes==='4h') return false;
        return true; // default safe
    }

    setupGame(r, m) {
        if(this.credits < 100) { alert("ä»£å¹£ä¸è¶³ï¼Œè«‹é‡æ•´é é¢é ˜å–è£œåŠ©ï¼"); this.showMenu(); return; }
        this.updateCredits(-100);
        this.isGameActive = true; this.rule = r; this.playerModes = m;
        this.wall = []; this.turn = 0; this.waitingForAction = false;
        this.hands=[[],[],[],[]]; this.melds=[[],[],[],[]]; this.discards=[[],[],[],[]]; this.flowers=[[],[],[],[]];
        this.scores = [25000, 25000, 25000, 25000];
        
        document.getElementById('mode-text').innerText = (r==='TW'?'è‡ºç£':'æ—¥æœ¬') + 'éº»å°‡';
        
        let deck = [];
        ['M','P','S'].forEach(s => { for(let i=1; i<=9; i++) for(let k=0; k<4; k++) deck.push(s+i); });
        for(let i=1; i<=7; i++) for(let k=0; k<4; k++) deck.push('Z'+i);
        if(r === 'TW') for(let i=1; i<=8; i++) deck.push('F'+i);
        
        // æ´—ç‰Œ
        for(let i=deck.length-1; i>0; i--) { const j=Math.floor(Math.random()*(i+1)); [deck[i], deck[j]] = [deck[j], deck[i]]; }
        this.wall = [...deck];

        const hs = r==='JP'?13:16;
        for(let p=0; p<4; p++) this.hands[p] = this.wall.splice(0, hs);
        
        if(r === 'TW') this.handleFlowerReplacement();
        
        for(let p=0; p<4; p++) this.hands[p].sort();

        this.createLabels(); 
        this.renderTiles(); 
        this.resetCameraToCurrentPlayer(); 
        
        this.surpriseEffect("ğŸ§§ ç¥ä½ é–‹å¼µå¤§å‰ï¼");
        setTimeout(() => this.nextTurn(), 1000);
    }

    updateCredits(amount) {
        this.credits += amount;
        this.updateCreditUI();
        if (amount < 0) {
            const el = document.createElement('div');
            el.innerText = amount; el.className = 'deduct-anim';
            el.style.left = '60px'; el.style.top = '10px';
            document.getElementById('game-info-panel').appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }
    }

    updateCreditUI() {
        document.getElementById('credit-display').innerText = this.credits;
    }

    handleFlowerReplacement() {
        let hasFlower = true;
        while(hasFlower) {
            hasFlower = false;
            for(let p=0; p<4; p++) {
                const flowerIndices = [];
                this.hands[p].forEach((code, idx) => {
                    if(code.startsWith('F')) flowerIndices.push(idx);
                });

                if (flowerIndices.length > 0) {
                    hasFlower = true;
                    for (let i = flowerIndices.length - 1; i >= 0; i--) {
                        const idx = flowerIndices[i];
                        const fTile = this.hands[p].splice(idx, 1)[0];
                        this.flowers[p].push(fTile);
                        if(this.wall.length > 0) {
                            this.hands[p].push(this.wall.pop()); 
                        }
                    }
                }
            }
        }
        for(let p=0; p<4; p++) this.hands[p].sort();
    }

    endGame() {
        this.isGameActive = false;
        if (this.autoDiscardTimeout) { clearTimeout(this.autoDiscardTimeout); this.autoDiscardTimeout = null; }
        document.getElementById('menu-overlay').style.display = 'flex';
        this.mahjongGroup.clear();
        this.tilesObjects = [];
    }

    createLabels() {
        this.labelsGroup.clear();
        const pos = [{x:0,z:13.5,r:0},{x:13.5,z:0,r:Math.PI/2},{x:0,z:-13.5,r:Math.PI},{x:-13.5,z:0,r:-Math.PI/2}];
        for(let i=0; i<4; i++) {
            const cvs = document.createElement('canvas'); cvs.width=256; cvs.height=64;
            const ctx = cvs.getContext('2d'); 
            const isComp = this.isComputer(i);
            ctx.fillStyle= isComp ? '#333' : '#b91c1c'; 
            ctx.roundRect(0,0,256,64,10); ctx.fill();
            ctx.fillStyle='#fff'; ctx.font='bold 36px Microsoft JhengHei'; ctx.textAlign='center'; ctx.textBaseline='middle';
            ctx.fillText((isComp?'é›»è…¦ ':'ç©å®¶ ')+(i+1), 128, 32);
            
            const m = new THREE.Mesh(new THREE.PlaneGeometry(5, 1.25), new THREE.MeshBasicMaterial({map:new THREE.CanvasTexture(cvs), transparent:true}));
            m.position.set(pos[i].x, 0.1, pos[i].z); m.rotation.set(-Math.PI/2, 0, pos[i].r);
            this.labelsGroup.add(m);
        }
    }

    renderTiles() {
        this.mahjongGroup.clear(); 
        this.tilesObjects = []; // é‡ç½®å¯é»æ“Šç‰©ä»¶åˆ—è¡¨
        const tW=0.9, tH=1.3, tD=0.6, hs=this.rule==='JP'?13:16;
        const tenpaiEl = document.getElementById('tenpai-alert'); if(tenpaiEl) tenpaiEl.remove();

        for(let p=0; p<4; p++){
            const hand = this.hands[p], hasDraw = hand.length > hs+(this.melds[p].length*3)%3;
            // ä¿®æ­£æ‰‹ç‰Œå¯¬åº¦è¨ˆç®—
            const off = ((hand.length * tW) / 2);

            // è½ç‰Œæª¢æŸ¥ (åªå°çœŸäººé¡¯ç¤º)
            if(!this.isComputer(p) && this.checkWin([...hand, hand[0]], true) && this.turn%4 === p) {
                const alert = document.createElement('div'); alert.id='tenpai-alert'; alert.className='tenpai-alert'; alert.innerText='ğŸ”¥ è½ç‰Œä¸­ï¼';
                document.getElementById('turn-indicator').appendChild(alert);
            }

            // æ¸²æŸ“æ‰‹ç‰Œ
            hand.forEach((c, i) => {
                const t = this.createTile(tW,tH,tD);
                // æœ€å¾Œä¸€å¼µç‰Œå¦‚æœæ˜¯å‰›æ‘¸åˆ°çš„ï¼Œéš”é–‹ä¸€é»è·é›¢
                let ip = (i * tW) - off; 
                if(hasDraw && i===hand.length-1) ip += 0.3;

                let x=0,z=0,r=0;
                if(p===0){x=ip;z=10.5;r=0;}
                else if(p===1){x=10.5;z=ip;r=Math.PI/2;}
                else if(p===2){x=-ip;z=-10.5;r=Math.PI;}
                else if(p===3){x=-10.5;z=-ip;r=-Math.PI/2;}
                
                // åªé¡¯ç¤ºè‡ªå·±(æˆ–å…¨é¡¯ç¤ºæ¨¡å¼)çš„ç‰Œé¢ï¼Œé›»è…¦ç‰Œè“‹è‘—
                if(!this.isComputer(p) || !this.isGameActive) this.addLabel(t, TILE_EMOJI[c], c);
                else if(this.isComputer(p)) { /* èƒŒé¢æœä¸Šï¼Œé è¨­æè³ªå°±æ˜¯èƒŒé¢ */ }
                
                t.position.set(x, tH/2, z); t.rotation.y = r;
                t.userData = { owner:p, index:i, code:c, type:'hand' };
                this.mahjongGroup.add(t);
                this.tilesObjects.push(t);
            });

            // æ¸²æŸ“é³´ç‰Œ (Melds)
            let mSt = (hand.length * tW / 2) + 1.5;
            // å¦‚æœæ‰‹ç‰Œå¤šï¼Œé³´ç‰Œå¾€å¤–æ¨
            if(p===1 || p===3) mSt += 1;

            this.melds[p].forEach((m, mi) => {
                m.forEach((c, ti) => {
                    const t = this.createTile(tW,tH,tD); this.addLabel(t, TILE_EMOJI[c], c);
                    let mp = mSt+(mi*3.2+ti)*tW, x=0,z=0,r=0;
                    if(p===0){x=mp;z=10.5;r=0;}
                    else if(p===1){x=10.5;z=mp;r=Math.PI/2;}
                    else if(p===2){x=-mp;z=-10.5;r=Math.PI;}
                    else if(p===3){x=-10.5;z=-mp;r=-Math.PI/2;}
                    t.position.set(x, tD/2, z); t.rotation.set(-Math.PI/2, 0, r+Math.PI);
                    this.mahjongGroup.add(t);
                });
            });

            // æ¸²æŸ“æ£„ç‰Œèˆ‡èŠ±ç‰Œ
            const riverStart = p===0 ? {x:-3, z:3} : (p===1 ? {x:3, z:-3} : (p===2 ? {x:3, z:-3} : {x:-3, z:3}));
            
            [...this.flowers[p], ...this.discards[p]].forEach((c, i) => {
                const t = this.createTile(tW,tH,tD); this.addLabel(t, TILE_EMOJI[c], c);
                let rw=Math.floor(i/6), cl=i%6, x=0,z=0,r=0;
                
                if(p===0){ x=(cl-3)*tW; z=2.5+rw*tH; r=0; }
                else if(p===1){ x=2.5+rw*tH; z=(cl-3)*tW; r=-Math.PI/2; }
                else if(p===2){ x=-(cl-3)*tW; z=-(2.5+rw*tH); r=Math.PI; }
                else if(p===3){ x=-(2.5+rw*tH); z=-(cl-3)*tW; r=Math.PI/2; }
                
                t.position.set(x, tD/2, z); t.rotation.set(-Math.PI/2, 0, r+Math.PI);
                this.mahjongGroup.add(t);
            });
        }
        document.getElementById('wall-text').innerText = this.wall.length;
    }

    createTile(w,h,d) {
        const mat = (c) => new THREE.MeshPhongMaterial({color:c});
        // 0:å³ 1:å·¦ 2:ä¸Š 3:ä¸‹ 4:å‰(é¢) 5:å¾Œ(èƒŒ)
        // éº»å°‡æ­£é¢æ˜¯ Index 4, èƒŒé¢æ˜¯ Index 5
        return new THREE.Mesh(new THREE.BoxGeometry(w,h,d), [
            mat(0xffffff), mat(0xffffff), mat(0xffffff), mat(0xffffff), 
            mat(0xffffff), mat(0x116a1e) // èƒŒé¢ç¶ è‰²
        ]);
    }

    addLabel(m, txt, c) {
        const cvs = document.createElement('canvas'); cvs.width=256; cvs.height=320;
        const ctx = cvs.getContext('2d'); 
        ctx.fillStyle='#fff'; ctx.fillRect(0,0,256,320); // ç™½åº•
        
        // ç¹ªè£½æ–‡å­—
        ctx.fillStyle = (c.match(/^[M]|Z7/)||c.startsWith('F'))?'#d60000':(c==='Z6'?'#008000':'#000');
        ctx.font = 'bold 200px "KaiTi", serif'; ctx.textAlign='center'; ctx.textBaseline='middle'; 
        ctx.fillText(txt, 128, 160);
        
        // é‚Šæ¡†
        ctx.strokeStyle = '#ddd'; ctx.lineWidth = 10; ctx.strokeRect(0,0,256,320);

        const l = new THREE.Mesh(new THREE.PlaneGeometry(0.9, 1.3), new THREE.MeshBasicMaterial({map:new THREE.CanvasTexture(cvs), transparent:true}));
        l.position.z = 0.31; // å¾®å‡¸
        l.rotation.y = 0; 
        m.add(l);
    }

    nextTurn() {
        if(!this.isGameActive || this.waitingForAction) return;
        const p = this.turn % 4, isC = this.isComputer(p);
        
        // UI æ›´æ–°
        document.getElementById('turn-indicator').innerText = `ğŸ§§ è¼ªåˆ° ${isC?`é›»è…¦ ${p}`:`ç©å®¶ ${p+1}`} äº†`;
        for(let i=0; i<4; i++) {
            const el = document.getElementById(`p${i}-ui`);
            if(i === p) { el.classList.add('text-yellow-300', 'font-black', 'scale-105', 'bg-white/10', 'rounded'); }
            else { el.classList.remove('text-yellow-300', 'font-black', 'scale-105', 'bg-white/10', 'rounded'); }
        }

        if(this.autoCamera && this.playerModes !== '1h3c') this.resetCameraToCurrentPlayer();

        if(this.wall.length > 0) {
            const newTile = this.wall.shift(); // å¾å‰é¢æ‘¸
            
            // èŠ±ç‰Œæª¢æŸ¥
            if (this.rule === 'TW' && newTile.startsWith('F')) {
                this.handleDrawFlower(p, newTile);
            } else {
                this.hands[p].push(newTile);
                this.renderTiles();
                
                // è‡ªæ‘¸æª¢æŸ¥
                if (this.checkWin(this.hands[p])) {
                    if(!isC) {
                        this.setupPlayerAction(p, newTile, 'tsumo');
                    } else {
                        // é›»è…¦è‡ªæ‘¸
                        setTimeout(() => {
                             this.showResult(p, 3000, `ğŸ€„ é›»è…¦ ${p} è‡ªæ‘¸ï¼`);
                             this.celebration.start(2000);
                        }, 1000);
                        return;
                    }
                } else {
                     if(isC) {
                        this.autoDiscardTimeout = setTimeout(() => this.autoDiscard(p), 1000 + Math.random()*1000);
                    }
                }
            }
        } else {
            this.showResult(-1, 0, "ğŸŒ‘ æµå±€");
        }
    }

    handleDrawFlower(playerId, flowerTile) {
        this.flowers[playerId].push(flowerTile); 
        this.showMessage(`è£œèŠ±ï¼š${TILE_EMOJI[flowerTile]}`);
        this.renderTiles();

        setTimeout(() => {
            if(this.wall.length > 0) {
                const replacementTile = this.wall.shift(); // å¾å‰é¢è£œ
                if (replacementTile.startsWith('F')) {
                    this.handleDrawFlower(playerId, replacementTile);
                } else {
                    this.hands[playerId].push(replacementTile);
                    this.renderTiles();
                    
                    if(this.checkWin(this.hands[playerId])) {
                         if(!this.isComputer(playerId)) this.setupPlayerAction(playerId, replacementTile, 'tsumo');
                         else {
                             setTimeout(() => this.showResult(playerId, 3000, "ğŸ€„ é›»è…¦è‡ªæ‘¸ï¼"), 1000);
                             return;
                         }
                    } else if(this.isComputer(playerId)) {
                        this.autoDiscardTimeout = setTimeout(() => this.autoDiscard(playerId), 1000);
                    }
                }
            } else {
                this.showResult(-1, 0, "ğŸŒ‘ ç‰Œç‰†è€—ç›¡");
            }
        }, 600);
    }
    
    setupPlayerAction(playerId, tile, type) {
        this.waitingForAction = true;
        this.currentActionContext = { tile: tile, from: playerId, type: type, playerIdx: playerId };
        
        document.getElementById('action-btns').classList.remove('hidden');
        document.getElementById('btn-chi').classList.add('hidden'); // è‡ªæ‘¸ä¸èƒ½åƒ
        document.getElementById('btn-pon').classList.add('hidden'); // è‡ªæ‘¸ä¸èƒ½ç¢°
        document.getElementById('btn-kan').classList.remove('hidden'); // å¯ä»¥æš—æ§“
        document.getElementById('btn-hu').classList.remove('hidden');
        document.getElementById('btn-hu').disabled = false;
        document.getElementById('btn-skip').classList.remove('hidden');
        document.getElementById('btn-skip').innerText = "éæ°´(å‡ºç‰Œ)";
        
        // éœ‡å‹•æç¤º
        if(navigator.vibrate) navigator.vibrate([200, 100, 200]);
    }

    autoDiscard(playerId) {
        if (!this.isGameActive) return;
        // ç°¡å–®AIï¼šéš¨æ©Ÿæ‰“ä¸€å¼µ
        const idx = Math.floor(Math.random() * this.hands[playerId].length);
        this.discardTile(playerId, idx);
    }

    discardTile(playerId, index) {
        if (!this.isGameActive) return;
        const tile = this.hands[playerId].splice(index, 1)[0];
        this.hands[playerId].sort();
        
        this.discards[playerId].push(tile);
        this.renderTiles();
        
        const label = this.isComputer(playerId) ? `é›»è…¦ ${playerId}` : `ç©å®¶ ${playerId + 1}`;
        this.showFocusTile(tile, label);
        this.hidePreview();

        // æª¢æŸ¥å…¶ä»–å®¶æ˜¯å¦èƒ¡ç‰Œ/ç¢°/åƒ
        let actionTriggered = false;
        
        // ç°¡åŒ–é‚è¼¯ï¼šæª¢æŸ¥é †ä½æœ€è¿‘çš„çœŸäººç©å®¶æ˜¯å¦æœ‰å‹•ä½œ (é˜²æ­¢å¤šäººåŒæ™‚è·³å‡ºè¦–çª—)
        for (let i = 1; i < 4; i++) {
            const checkPlayerId = (playerId + i) % 4;
            if (this.isComputer(checkPlayerId)) continue;
            
            const actions = this.checkAvailableActions(tile, playerId, checkPlayerId);
            if (actions.length > 0) {
                this.triggerPlayerAction(actions, tile, playerId, false, checkPlayerId);
                actionTriggered = true;
                break; // æš«åœï¼Œç­‰å¾…è©²ç©å®¶å›æ‡‰
            }
        }

        if (!actionTriggered) {
            setTimeout(() => this.finishTurn(), 800);
        }
    }

    finishTurn() {
        this.turn++;
        this.nextTurn();
    }

    checkAvailableActions(tileCode, discarderId, checkerId) {
        const hand = this.hands[checkerId];
        const actions = [];
        
        // æª¢æŸ¥èƒ¡
        if (this.checkWin([...hand, tileCode])) actions.push('hu');

        // æª¢æŸ¥ç¢°/æ§“
        const sameCount = hand.filter(t => t === tileCode).length;
        if (sameCount >= 2) actions.push('pon');
        if (sameCount >= 3) actions.push('kan');
        
        // æª¢æŸ¥åƒ (åƒ…ä¸‹å®¶)
        if ((discarderId + 1) % 4 === checkerId && tileCode.match(/[MPS]/)) { 
            const suit = tileCode.charAt(0);
            const num = parseInt(tileCode.charAt(1));
            const handNums = hand.filter(t => t.startsWith(suit)).map(t => parseInt(t.charAt(1)));
            
            if ((handNums.includes(num-2) && handNums.includes(num-1)) ||
                (handNums.includes(num-1) && handNums.includes(num+1)) ||
                (handNums.includes(num+1) && handNums.includes(num+2))) {
                actions.push('chi');
            }
        }
        return actions;
    }

    triggerPlayerAction(actions, tileCode, discarderId, isSelfDraw, playerIdx) {
        this.waitingForAction = true;
        this.currentActionContext = { tile: tileCode, from: discarderId, type: 'ron', playerIdx: playerIdx };
        
        if (this.autoCamera) {
            const config = this.camConfigs[playerIdx];
            new TWEEN.Tween(this.camera.position).to(config.pos, 500).easing(TWEEN.Easing.Cubic.Out).start();
            new TWEEN.Tween(this.controls.target).to(config.target, 500).easing(TWEEN.Easing.Cubic.Out).start();
        }

        document.getElementById('action-btns').classList.remove('hidden');
        
        ['chi', 'pon', 'kan', 'hu'].forEach(act => {
            const btn = document.getElementById(`btn-${act}`);
            btn.classList.remove('hidden');
            if (actions.includes(act)) {
                btn.disabled = false; btn.style.opacity = '1';
                if(act === 'hu') btn.classList.add('btn-hu-active');
            } else {
                btn.disabled = true; btn.style.opacity = '0.3'; btn.classList.remove('btn-hu-active');
            }
        });
        
        const skipBtn = document.getElementById('btn-skip');
        skipBtn.innerText = "é";
        skipBtn.onclick = () => game.handlePlayerAction('skip');
        
        document.getElementById('preview-overlay').style.opacity = '1';
        // éœ‡å‹•æç¤º
        if(navigator.vibrate) navigator.vibrate(200);
    }

    handlePlayerAction(action) {
        document.getElementById('action-btns').classList.add('hidden');
        document.getElementById('preview-overlay').style.opacity = '0';
        document.getElementById('chi-select-btns').classList.add('hidden');
        this.waitingForAction = false;
        
        const ctx = this.currentActionContext;

        // è‡ªæ‘¸èƒ¡
        if (ctx.type === 'tsumo') {
            if (action === 'hu') {
                this.showResult(ctx.playerIdx, 3000, "ğŸ§§ è‡ªæ‘¸ï¼æ­å–œç™¼è²¡ï¼");
                this.celebration.start();
            } else {
                // éæ°´ = å‡ºç‰Œ
                this.hidePreview();
                this.waitingForAction = false;
                this.showMessage("éæ°´");
            }
            return;
        }

        // æ”¾æ§èƒ¡
        if (action === 'hu') {
            this.showResult(ctx.playerIdx, 2000, "ğŸ§§ èƒ¡ç‰Œï¼");
            this.celebration.start();
            return;
        }

        if (action === 'skip') {
            this.showMessage("é");
            this.finishTurn();
            return;
        }

        // åŸ·è¡Œåƒç¢°æ§“
        if (action === 'chi') {
             const hand = this.hands[ctx.playerIdx];
             const tile = ctx.tile;
             const s = tile[0], n = parseInt(tile[1]);
             const combos = [];
             // æ‰¾å‡ºæ‰€æœ‰å¯èƒ½çš„åƒç‰Œçµ„åˆ
             if (hand.includes(s+(n-2)) && hand.includes(s+(n-1))) combos.push([s+(n-2), s+(n-1), tile]);
             if (hand.includes(s+(n-1)) && hand.includes(s+(n+1))) combos.push([s+(n-1), tile, s+(n+1)]);
             if (hand.includes(s+(n+1)) && hand.includes(s+(n+2))) combos.push([tile, s+(n+1), s+(n+2)]);
             
             if (combos.length > 1) {
                 this.showChiSelection(combos, ctx.playerIdx, tile);
                 return; 
             } else if (combos.length === 1) {
                 this.discards[ctx.from].pop(); 
                 this.executeChi(ctx.playerIdx, combos[0], tile);
             }
        } else {
             this.discards[ctx.from].pop();
             this.executeMeld(ctx.playerIdx, action, ctx.tile);
        }
        
        this.finalizeAction(ctx.playerIdx);
    }

    showChiSelection(combos, pIdx, targetTile) {
        this.waitingForAction = true; 
        const container = document.getElementById('chi-select-btns');
        container.innerHTML = ''; 
        container.classList.remove('hidden');
        document.getElementById('preview-overlay').style.opacity = '1';

        combos.forEach((combo) => {
            const btn = document.createElement('button');
            btn.className = 'btn-chi-select';
            let text = '';
            combo.sort().forEach(c => text += TILE_EMOJI[c]);
            btn.innerText = text;
            btn.onclick = () => {
                container.classList.add('hidden');
                document.getElementById('preview-overlay').style.opacity = '0';
                this.discards[this.currentActionContext.from].pop(); 
                this.executeChi(pIdx, combo, targetTile);
                this.finalizeAction(pIdx);
            };
            container.appendChild(btn);
        });
    }

    executeChi(pIdx, comboTiles, targetTile) {
        const hand = this.hands[pIdx];
        const toRemove = [...comboTiles];
        // ç§»é™¤é™¤äº†ç›®æ¨™ç‰Œä¹‹å¤–çš„æ‰‹ç‰Œ (ç›®æ¨™ç‰Œå·²ç¶“åœ¨comboTilesè£¡ï¼Œä½†å…¶å¯¦ä¸åœ¨æ‰‹ç‰Œè£¡)
        const targetIdx = toRemove.indexOf(targetTile);
        if (targetIdx > -1) toRemove.splice(targetIdx, 1); 
        
        toRemove.forEach(t => {
            const idx = hand.indexOf(t);
            if (idx > -1) hand.splice(idx, 1);
        });
        this.melds[pIdx].push(comboTiles.sort());
    }

    executeMeld(playerId, type, targetTile) {
        const hand = this.hands[playerId];
        const meld = [targetTile]; 
        
        if (type === 'pon') {
            for(let i=0; i<2; i++) {
                const idx = hand.indexOf(targetTile);
                if(idx > -1) meld.push(hand.splice(idx, 1)[0]);
            }
        } else if (type === 'kan') {
            for(let i=0; i<3; i++) {
                const idx = hand.indexOf(targetTile);
                if(idx > -1) meld.push(hand.splice(idx, 1)[0]);
            }
        }
        this.melds[playerId].push(meld);
    }

    finalizeAction(pIdx) {
        this.turn = pIdx; 
        this.renderTiles(); 
        this.waitingForAction = false;
        this.currentActionContext = null;
        // åƒç¢°æ§“å®Œå¾Œï¼Œè¼ªåˆ°è©²ç©å®¶å‡ºç‰Œ
        document.getElementById('turn-indicator').innerText = `è¼ªåˆ° ç©å®¶ ${pIdx+1} å‡ºç‰Œ`;
    }

    showFocusTile(tileCode, playerName) {
        const overlay = document.getElementById('preview-overlay');
        const box = document.getElementById('preview-box');
        const emoji = document.getElementById('preview-emoji');
        const text = document.getElementById('preview-text');
        const sub = document.getElementById('preview-sub');
        const hint = document.getElementById('preview-hint');
        
        emoji.innerText = TILE_EMOJI[tileCode];
        text.innerText = playerName + " æ‰“å‡º";
        sub.innerText = "";
        hint.classList.add('hidden'); 
        box.classList.remove('interactive-preview'); 
        
        box.classList.remove('preview-anim');
        void box.offsetWidth;
        box.classList.add('preview-anim');
        overlay.style.opacity = '1';
        
        if (!this.waitingForAction) {
            setTimeout(() => { if(!this.waitingForAction) overlay.style.opacity = '0'; }, 1200);
        }
    }

    onPointerDown(event) {
        event.preventDefault(); // é˜²æ­¢æ»¾å‹•
        this.pointerDownTime = Date.now();
        const clientX = event.touches ? event.touches[0].clientX : event.clientX;
        const clientY = event.touches ? event.touches[0].clientY : event.clientY;
        this.pointerDownPos.set(clientX, clientY);
    }

    onPointerUp(event) {
        event.preventDefault();
        const clientX = event.changedTouches ? event.changedTouches[0].clientX : event.clientX;
        const clientY = event.changedTouches ? event.changedTouches[0].clientY : event.clientY;
        const timeDiff = Date.now() - this.pointerDownTime;
        const distDiff = Math.hypot(clientX - this.pointerDownPos.x, clientY - this.pointerDownPos.y);
        
        // åˆ¤å®šç‚ºé»æ“Šè€Œéæ‹–æ›³
        if (timeDiff < 500 && distDiff < 10) {
            this.handleTap(clientX, clientY);
        }
    }
    
    // æ¡Œé¢ç‰ˆæ»‘é¼ ç§»å‹•æ•ˆæœ (Hover)
    onMouseMove(event) {
        // åªæœ‰éç­‰å¾…å‹•ä½œä¸”éŠæˆ²é€²è¡Œä¸­æ‰æª¢æ¸¬
        if (!this.isGameActive || this.waitingForAction || window.innerWidth < 1024) return;
        
        const currentId = this.turn % 4;
        if (this.isComputer(currentId)) return;

        this.mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        this.mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
        this.raycaster.setFromCamera(this.mouse, this.camera);
        
        // æª¢æ¸¬æ˜¯å¦æ»‘éè‡ªå·±çš„æ‰‹ç‰Œ
        const intersects = this.raycaster.intersectObjects(this.tilesObjects, true);
        
        // æ¢å¾©ä¹‹å‰çš„æ‡¸åœæ•ˆæœ
        if (this.hoveredTile && this.hoveredTile !== this.selectedTile) {
            new TWEEN.Tween(this.hoveredTile.position).to({y: 0.65}, 100).easing(TWEEN.Easing.Quadratic.Out).start();
            this.hoveredTile = null;
        }

        if (intersects.length > 0) {
            let targetObj = intersects[0].object;
            while(targetObj && (!targetObj.userData || targetObj.userData.type !== 'hand')) {
                if(targetObj.parent) targetObj = targetObj.parent; else break;
            }
            
            // å¦‚æœæ»‘éè‡ªå·±çš„ç‰Œï¼Œä¸”ä¸æ˜¯å·²é¸å–çš„ç‰Œ
            if(targetObj && targetObj.userData && targetObj.userData.owner === currentId && targetObj !== this.selectedTile) {
                this.hoveredTile = targetObj;
                new TWEEN.Tween(targetObj.position).to({y: 0.85}, 100).easing(TWEEN.Easing.Quadratic.Out).start();
                document.body.style.cursor = 'pointer';
            } else {
                document.body.style.cursor = 'default';
            }
        } else {
            document.body.style.cursor = 'default';
        }
    }

    // éµç›¤æ“ä½œæ”¯æ´
    onKeyDown(event) {
        if (!this.isGameActive) return;
        
        // ç©ºç™½éµï¼šå¦‚æœæœ‰é¸å–ç‰Œ -> å‡ºç‰Œï¼›å¦‚æœæ˜¯ç­‰å¾…æ“ä½œ -> éæ°´
        if (event.code === 'Space') {
            event.preventDefault();
            if (this.selectedTile && !this.waitingForAction) {
                this.confirmDiscardFromPreview();
            } else if (this.waitingForAction) {
                // å¦‚æœæœ‰éæ°´æŒ‰éˆ•ï¼Œå°±è§¸ç™¼éæ°´
                const skipBtn = document.getElementById('btn-skip');
                if (!skipBtn.classList.contains('hidden') && !skipBtn.disabled) {
                    this.handlePlayerAction('skip');
                }
            }
        }
        
        // Esc: å–æ¶ˆé¸å– / å›é¸å–®
        if (event.code === 'Escape') {
            if(this.selectedTile) this.clearSelection();
            else if(!this.waitingForAction) {
                 // Open menu logic could go here
            }
        }
    }

    handleTap(clientX, clientY) {
        if (!this.isGameActive || this.waitingForAction) {
             if (this.currentActionContext && this.currentActionContext.type === 'tsumo') {
                 // å…è¨±è‡ªæ‘¸æ™‚é»æ“Šç©ºç™½è™•å–æ¶ˆé è¦½ï¼Œä½†ä¸å…è¨±æ‰“ç‰Œ
                 this.hidePreview();
                 this.clearSelection();
                 return;
             }
             return;
        }

        const currentId = this.turn % 4;
        if (this.isComputer(currentId)) return; 

        this.mouse.x = (clientX / window.innerWidth) * 2 - 1;
        this.mouse.y = -(clientY / window.innerHeight) * 2 + 1;
        this.raycaster.setFromCamera(this.mouse, this.camera);
        
        const intersects = this.raycaster.intersectObjects(this.tilesObjects, true);

        if (intersects.length > 0) {
            let targetObj = intersects[0].object;
            // å‘ä¸Šå°‹æ‰¾ç›´åˆ°æ‰¾åˆ°å¸¶æœ‰ userData çš„ç‰©ä»¶
            while(targetObj && (!targetObj.userData || targetObj.userData.type !== 'hand')) {
                if(targetObj.parent) targetObj = targetObj.parent;
                else break;
            }

            if(targetObj && targetObj.userData && targetObj.userData.owner === currentId) {
                this.onTileClick(targetObj, currentId);
            }
        } else {
            this.clearSelection();
            this.hidePreview();
        }
    }

    onTileClick(obj, playerId) {
        // å¦‚æœå†æ¬¡é»æ“ŠåŒä¸€å¼µç‰Œ -> å‡ºç‰Œ
        if (this.selectedTile === obj) {
            this.discardTile(playerId, obj.userData.index);
            this.clearSelection();
        } else {
            // é¸å–æ–°ç‰Œ
            this.clearSelection();
            this.selectedTile = obj;
            
            // è¦–è¦ºå›é¥‹ï¼šä¸Šæµ®
            new TWEEN.Tween(obj.position).to({y: 1.5}, 200).easing(TWEEN.Easing.Quadratic.Out).start();
            
            this.showPreview(obj.userData.code);
        }
    }
    
    confirmDiscardFromPreview() {
        if(this.selectedTile && !this.waitingForAction && this.isGameActive) {
            const owner = this.selectedTile.userData.owner;
            if(owner === (this.turn % 4) && !this.isComputer(owner)) {
                this.discardTile(owner, this.selectedTile.userData.index);
                this.clearSelection();
            }
        }
    }

    clearSelection() {
        if (this.selectedTile) {
            new TWEEN.Tween(this.selectedTile.position).to({y: 0.65}, 200).easing(TWEEN.Easing.Quadratic.Out).start();
            this.selectedTile = null;
        }
    }
    
    showPreview(tileCode) {
        const overlay = document.getElementById('preview-overlay');
        const box = document.getElementById('preview-box');
        const emoji = document.getElementById('preview-emoji');
        const text = document.getElementById('preview-text');
        const sub = document.getElementById('preview-sub');
        const hint = document.getElementById('preview-hint');

        emoji.innerText = TILE_EMOJI[tileCode];
        text.innerText = "å·²é¸å–";
        sub.innerText = "é»æ“Šå‡ºç‰Œ";
        hint.classList.remove('hidden'); 
        box.classList.add('interactive-preview'); 
        
        box.classList.remove('preview-anim');
        void box.offsetWidth;
        box.classList.add('preview-anim');
        overlay.style.opacity = '1';
    }
    
    hidePreview() { document.getElementById('preview-overlay').style.opacity = '0'; }
    showMessage(txt) {
        const box = document.getElementById('msg-box');
        box.innerText = txt; box.style.opacity = '1'; box.style.transform = 'translate(-50%, -50%) scale(1)';
        setTimeout(() => { box.style.opacity = '0'; box.style.transform = 'translate(-50%, -50%) scale(0.9)'; }, 1500);
    }
    surpriseEffect(txt) { this.showMessage(txt); this.celebration.start(1000); }
    showResult(winner, coins, title) {
        this.isGameActive = false;
        document.getElementById('result-overlay').style.display='flex';
        document.getElementById('result-title').innerText=title;
        document.getElementById('result-winner').innerText=winner===-1?"å¯æƒœæµå±€":`ç©å®¶ ${winner+1} ç²å‹`;
        document.getElementById('result-coins').innerText=winner===-1?"":`ä»£å¹£ ${coins>0?'+':''}${coins}`;
        const h=document.getElementById('result-hand'); h.innerHTML='';
        if(winner!==-1) this.hands[winner].forEach(c=>{const s=document.createElement('span');s.innerText=TILE_EMOJI[c];h.appendChild(s);});
        
        if(winner !== -1 && !this.isComputer(winner)) this.updateCredits(coins);
        // å¦‚æœæ˜¯çœŸäººè¼¸äº†
        if(winner !== -1 && this.isComputer(winner) && this.playerModes === '3h1c') {
            // ç°¡åŒ–ï¼šå–®äººæ¨¡å¼ä¸‹åªé¡¯ç¤ºä¸€ç¨®æ‰£åˆ†
            this.updateCredits(-coins); 
        }
    }
    restartCurrent(){ this.celebration.stop(); this.setupGame(this.rule, this.playerModes); document.getElementById('result-overlay').style.display='none'; }
    showMenu(){ this.celebration.stop(); this.isGameActive=false; document.getElementById('result-overlay').style.display='none'; document.getElementById('menu-overlay').style.display='flex'; }

    // --- èƒ¡ç‰Œæ¼”ç®—æ³• (Backtracking) ---
    checkWin(hand, isTenpaiCheck = false) {
        // éæ¿¾èŠ±ç‰Œ
        const pureHand = hand.filter(t => !t.startsWith('F'));
        const tileCounts = {};
        pureHand.forEach(t => tileCounts[t] = (tileCounts[t] || 0) + 1);
        
        // æª¢æŸ¥ä¸ƒå°å­ (ç‰¹æ®Šç‰Œå‹)
        let pairs = 0;
        for(let t in tileCounts) if(tileCounts[t] >= 2) pairs++;
        if(pairs === 7 && pureHand.length === 14) return true;
        // å°ç£éº»å°‡16å¼µç‰Œï¼Œä¸ƒå°å­ä¸æ˜¯æ¨™æº–ç‰Œå‹ï¼Œä½†é€™è£¡ç°¡å–®å…¼å®¹

        // æ¨™æº–æª¢æŸ¥ï¼šç§»é™¤ä¸€å°çœ¼ï¼Œå‰©ä¸‹èƒ½å¦çµ„æˆé¢å­
        const tiles = Object.keys(tileCounts).sort();
        for(let t of tiles) {
            if(tileCounts[t] >= 2) {
                tileCounts[t] -= 2;
                if(this.solveMelds(tileCounts, pureHand.length - 2)) return true;
                tileCounts[t] += 2; // Backtrack
            }
        }
        return false;
    }

    solveMelds(counts, remainingTiles) {
        if(remainingTiles === 0) return true;
        
        // æ‰¾ç¬¬ä¸€å¼µå¯ç”¨çš„ç‰Œ
        let first = null;
        for(let t in counts) {
            if(counts[t] > 0) { first = t; break; }
        }
        if(!first) return true;

        // å˜—è©¦åˆ»å­ (AAA)
        if(counts[first] >= 3) {
            counts[first] -= 3;
            if(this.solveMelds(counts, remainingTiles - 3)) return true;
            counts[first] += 3; // Backtrack
        }

        // å˜—è©¦é †å­ (ABC) - åƒ…é™æ•¸ç‰Œ
        if(first.match(/^[MPS]/)) {
            const s = first[0], n = parseInt(first[1]);
            const t2 = s + (n+1), t3 = s + (n+2);
            if(counts[t2] > 0 && counts[t3] > 0) {
                counts[first]--; counts[t2]--; counts[t3]--;
                if(this.solveMelds(counts, remainingTiles - 3)) return true;
                counts[first]++; counts[t2]++; counts[t3]++; // Backtrack
            }
        }
        return false;
    }
}

let game = new MahjongGame();
let selectedRule = 'TW';

function selectRule(rule) {
    selectedRule = rule;
    const twBtn = document.getElementById('menu-rule-tw');
    const jpBtn = document.getElementById('menu-rule-jp');
    const activeClass = "rule-btn-active";
    const inactiveClass = "rule-btn-inactive";
    
    if(rule === 'TW') {
        twBtn.className = twBtn.className.replace(inactiveClass, activeClass);
        jpBtn.className = jpBtn.className.replace(activeClass, inactiveClass);
    } else {
        jpBtn.className = jpBtn.className.replace(inactiveClass, activeClass);
        twBtn.className = twBtn.className.replace(activeClass, inactiveClass);
    }
}

function startGame() {
    // å˜—è©¦æ’­æ”¾éŸ³æ¨‚ (éœ€ç”¨æˆ¶äº’å‹•)
    const audio = document.getElementById('bgm');
    audio.volume = 0.4;
    audio.play().catch(e => console.log("ç­‰å¾…äº’å‹•æ’­æ”¾éŸ³æ¨‚"));

    const mode = document.getElementById('player-mode-select').value;
    document.getElementById('menu-overlay').style.display = 'none';
    
    game.init(); 
    game.setupGame(selectedRule, mode);
}

window.onload = () => {
    selectRule('TW');
    // é˜²æ­¢æ‰‹æ©Ÿé›™æ“Šæ”¾å¤§
    document.addEventListener('dblclick', function(event) {
        event.preventDefault();
    }, { passive: false });
};
</script>

</body>
</html>
