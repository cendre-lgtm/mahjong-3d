<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ–°æ˜¥å–œæ…¶ç‰ˆï¼šå°æ—¥é›™åˆ¶ç«‹é«”éº»å°‡</title>
    <!-- Three.js Core -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- OrbitControls for Rotation -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <!-- TWEEN.js for smooth animation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #2d0a0a; font-family: 'Microsoft JhengHei', sans-serif; touch-action: none; user-select: none; -webkit-user-select: none; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50; }
        .interactive { pointer-events: auto; }
        canvas { display: block; }
        
        /* ç¯€æ…¶æŒ‰éˆ•æ¨£å¼ - éŸ¿æ‡‰å¼èª¿æ•´ */
        .btn-festive { 
            background: linear-gradient(135deg, #d4af37 0%, #aa8a2e 100%); 
            color: #4a0404;
            border-radius: 12px; 
            font-weight: 900; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            transition: all 0.1s;
            border: 2px solid #fff5d7;
            text-shadow: 0 1px 0 rgba(255,255,255,0.3);
            padding: 10px 16px;
            font-size: 1.1rem;
            min-width: 70px;
        }
        @media (min-width: 768px) {
            .btn-festive {
                padding: 14px 24px;
                font-size: 1.3rem;
                min-width: 90px;
            }
        }
        .btn-festive:active { transform: scale(0.95); }
        .btn-festive:disabled { filter: grayscale(1); opacity: 0.5; pointer-events: none; }
        
        /* äº®èµ·çš„èƒ¡ç‰ŒæŒ‰éˆ•ç‰¹æ•ˆ */
        .btn-hu-active {
            animation: pulse-gold 1.5s infinite;
            background: linear-gradient(135deg, #ff0000 0%, #990000 100%) !important;
            color: white !important;
            border-color: #ffd700 !important;
            box-shadow: 0 0 25px #ff0000 !important;
            transform: scale(1.1);
        }
        @keyframes pulse-gold {
            0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(255, 215, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
        }

        .gold-text { color: #d4af37; text-shadow: 1px 1px 2px rgba(0,0,0,0.8); }
        .red-panel { background: rgba(139, 0, 0, 0.85); border: 2px solid #d4af37; box-shadow: 0 4px 20px rgba(0,0,0,0.6); }
        
        /* çµæŸæŒ‰éˆ•ç‰¹åˆ¥æ¨£å¼ */
        .btn-exit {
            background: linear-gradient(135deg, #c0392b 0%, #8e44ad 100%);
            color: white; border: 2px solid #e74c3c;
            border-radius: 50px; 
            font-weight: bold; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            display: flex; align-items: center; gap: 5px;
            padding: 6px 12px; font-size: 0.8rem;
        }
        @media (min-width: 768px) { .btn-exit { padding: 8px 16px; font-size: 0.9rem; } }
        .btn-exit:active { transform: scale(0.95); }

        /* é©šå–œå‹•ç•« */
        @keyframes firework {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .surprise-text { animation: firework 0.5s ease-out forwards; }

        /* ç‰¹å¯«å‹•ç•« */
        .preview-anim { animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        /* æ“ä½œæŒ‡å¼•æç¤º */
        .tutorial-hint { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

        /* å³ä¸‹è§’åŠŸèƒ½æŒ‰éˆ•ç¾¤ */
        .ctrl-btn {
            background: rgba(0,0,0,0.6); border: 1px solid #d4af37;
            color: #d4af37; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            pointer-events: auto; cursor: pointer; margin-top: 10px;
            transition: all 0.3s;
            width: 40px; height: 40px; font-size: 20px;
        }
        @media (min-width: 768px) { .ctrl-btn { width: 50px; height: 50px; font-size: 24px; } }
        .ctrl-btn.active { background: #d4af37; color: #000; box-shadow: 0 0 10px #d4af37; }
        
        .hidden-ctrl { display: none !important; }

        /* ç‰¹å¯«é è¦½å€äº’å‹•æ¨£å¼ */
        #preview-box.interactive-preview {
            cursor: pointer;
            pointer-events: auto;
            transition: transform 0.1s ease;
        }
        #preview-box.interactive-preview:active {
            transform: scale(0.85) !important; /* é»æ“Šæ™‚ç¸®å°æ•ˆæœ */
        }
        
        /* æ‰£æ¬¾å‹•ç•« */
        @keyframes fadeUp {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        .deduct-anim {
            position: absolute;
            color: #ff4d4d;
            font-weight: bold;
            animation: fadeUp 1s forwards;
            pointer-events: none;
        }
        
        /* åƒç‰Œé¸æ“‡æŒ‰éˆ• */
        .btn-chi-select {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: 2px solid #6ee7b7; color: white;
            padding: 10px 20px; border-radius: 12px; font-size: 1.5rem;
            display: flex; gap: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .btn-chi-select:active { transform: scale(0.95); }
    </style>
</head>
<body>

<div id="game-container"></div>

<audio id="bgm" loop>
    <source src="https://raw.githubusercontent.com/cendre-lgtm/2026/refs/heads/main/(%E6%AD%A1%E5%BF%AB)%20%E6%96%B0%E5%B9%B4%EF%BD%9C%E5%85%8D%E8%B2%BB%E8%83%8C%E6%99%AF%E9%9F%B3%E6%A8%82%E4%B8%8B%E8%BC%89%EF%BD%9C%E7%84%A1%E7%89%88%E6%AC%8A%E9%85%8D%E6%A8%82%EF%BD%9CBGM%EF%BD%9CNCS%20%E3%80%90%E8%83%A4%E6%A8%82%E9%9F%B3%E6%A8%82%E3%80%91%20(7).mp3" type="audio/mpeg">
</audio>

<!-- UI åœ–å±¤ -->
<div id="ui-layer" class="flex flex-col justify-between p-2 md:p-4 h-full">
    <div class="flex justify-between items-start interactive w-full">
        <!-- å·¦ä¸Šè§’è³‡è¨Šå€ -->
        <div class="flex flex-col gap-2 items-start max-w-[45%]">
            <button onclick="returnToMenu()" class="btn-exit">
                <span>ğŸ </span> <span class="hidden sm:inline">çµæŸç‰Œå±€</span><span class="sm:hidden">çµæŸ</span>
            </button>
            <div id="game-info" class="red-panel text-white p-2 md:p-3 rounded-xl text-xs md:text-sm backdrop-blur-md shadow-lg w-full relative">
                <div class="whitespace-nowrap flex items-center gap-2">
                    <span class="text-yellow-400">ğŸ’° ä»£å¹£:</span> 
                    <span id="credit-count" class="font-mono font-bold text-white">10000</span>
                </div>
                <div class="w-full h-[1px] bg-white/20 my-1"></div>
                <div class="whitespace-nowrap">æ¨¡å¼: <span id="mode-display" class="font-bold text-yellow-300">-</span></div>
                <div class="whitespace-nowrap">é¢¨åœˆ: <span class="text-yellow-100 font-bold">æ±é¢¨</span></div>
                <div class="whitespace-nowrap">ç‰Œæ•¸: <span id="wall-count" class="font-mono text-yellow-200">--</span></div>
            </div>
        </div>

        <!-- å³ä¸Šè§’åˆ†æ•¸æ¿ -->
        <div id="score-board" class="red-panel text-white p-2 md:p-3 rounded-xl text-xs md:text-sm text-right backdrop-blur-md shadow-lg max-w-[50%]">
            <div id="p0-ui" class="gold-text transition-all duration-300">ç©å®¶ 1: <span id="s0">25000</span></div>
            <div id="p1-ui" class="transition-all duration-300">ç©å®¶ 2: <span id="s1">25000</span></div>
            <div id="p2-ui" class="transition-all duration-300">ç©å®¶ 3: <span id="s2">25000</span></div>
            <div id="p3-ui" class="transition-all duration-300">ç©å®¶ 4: <span id="s3">25000</span></div>
        </div>
    </div>

    <!-- é¸ç‰Œ/å‡ºç‰Œ ç‰¹å¯«é è¦½å€ (ç™½åº•ï¼Œæ·±è‰²å­—) -->
    <div id="preview-overlay" class="pointer-events-none fixed inset-0 flex flex-col items-center justify-center z-30 opacity-0 transition-opacity duration-200">
        <!-- ç‰Œé¢ç‰¹å¯« (æ–°å¢é»æ“Šå‡ºç‰ŒåŠŸèƒ½) -->
        <div class="bg-white/95 p-4 md:p-6 rounded-3xl border-4 border-yellow-600 backdrop-blur-md shadow-2xl flex flex-col items-center transform scale-75 md:scale-90 mb-2 md:mb-6 interactive-preview" 
             id="preview-box" onclick="game.confirmDiscardFromPreview()">
            <div id="preview-emoji" class="text-8xl md:text-[9rem] leading-none mb-2 filter drop-shadow-[0_5px_15px_rgba(0,0,0,0.3)]">ğŸ€„</div>
            <div id="preview-text" class="text-red-800 text-xl md:text-2xl font-black tracking-widest text-center whitespace-nowrap"></div>
            <div id="preview-sub" class="text-gray-600 text-xs md:text-sm mt-1 font-bold text-center"></div>
            <div id="preview-hint" class="text-green-600 text-xs mt-2 font-bold animate-pulse hidden">(é»æ“Šæ­¤è™•å‡ºç‰Œ)</div>
        </div>

        <!-- å‹•ä½œæŒ‰éˆ•ç¾¤ -->
        <div id="action-btns" class="flex flex-wrap justify-center gap-2 md:gap-3 hidden pointer-events-auto transform scale-90 md:scale-100 max-w-[90vw]">
            <button id="btn-chi" onclick="game.handlePlayerAction('chi')" class="btn-festive bg-green-600 text-white border-green-300 shadow-[0_0_20px_rgba(34,197,94,0.6)]">åƒ</button>
            <button id="btn-pon" onclick="game.handlePlayerAction('pon')" class="btn-festive bg-blue-600 text-white border-blue-300 shadow-[0_0_20px_rgba(59,130,246,0.6)]">ç¢°</button>
            <button id="btn-kan" onclick="game.handlePlayerAction('kan')" class="btn-festive bg-purple-600 text-white border-purple-300 shadow-[0_0_20px_rgba(147,51,234,0.6)]">æ§“</button>
            <button id="btn-hu" onclick="game.handlePlayerAction('hu')" class="btn-festive !bg-red-600 !text-white !border-white !shadow-[0_0_25px_rgba(220,38,38,0.8)]">èƒ¡</button>
            <button id="btn-skip" onclick="game.handlePlayerAction('skip')" class="btn-festive !bg-gray-700 !text-gray-200 !border-gray-500">é</button>
        </div>

        <!-- åƒç‰Œé¸æ“‡ç¾¤ (ç¨ç«‹é¡¯ç¤º) -->
        <div id="chi-select-btns" class="flex flex-wrap justify-center gap-4 hidden pointer-events-auto transform scale-90 md:scale-100 max-w-[95vw]">
            <!-- å‹•æ…‹ç”Ÿæˆé¸é … -->
        </div>
    </div>

    <!-- è¨Šæ¯æç¤º -->
    <div id="msg-box" class="pointer-events-none fixed top-[20%] left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-red-600 text-yellow-300 border-2 border-yellow-400 px-6 py-3 md:px-8 md:py-4 rounded-full font-black opacity-0 transition-all shadow-2xl scale-110 z-50 whitespace-nowrap text-sm md:text-base">
        <!-- è¨Šæ¯é¡¯ç¤ºè™• -->
    </div>

    <!-- å³ä¸‹è§’æ§åˆ¶å€ -->
    <div id="controls-area" class="absolute bottom-20 right-4 md:bottom-6 md:right-6 flex flex-col items-end z-20 gap-2">
        <button id="cam-toggle-btn" class="ctrl-btn active" onclick="game.toggleAutoCamera()" title="è‡ªå‹•è·Ÿéš¨è¦–è§’">
            ğŸ“¹
        </button>
        <button id="reset-cam-btn" class="ctrl-btn" onclick="game.resetCameraToCurrentPlayer()" title="é‡ç½®è¦–è§’">
            â†º
        </button>
    </div>

    <!-- åº•éƒ¨æ§åˆ¶å€ -->
    <div class="flex flex-col gap-2 md:gap-4 interactive pb-4 md:pb-8 pointer-events-none items-center w-full">
        <div id="turn-indicator" class="pointer-events-auto text-center text-yellow-400 text-lg md:text-xl font-black drop-shadow-[0_2px_4px_rgba(0,0,0,0.8)] tracking-widest bg-black/40 py-2 rounded-lg px-6 backdrop-blur-sm mb-1">
            ç­‰å¾…å‰æ™‚é–‹å±€...
        </div>
        <div id="hint-text" class="text-center text-yellow-500/80 text-xs md:text-sm font-bold drop-shadow-md tutorial-hint pointer-events-none">
            (å–®æŒ‡è½‰è¦–è§’ â€¢ é»æ“Šé¸ç‰Œ â€¢ é›™æ“Šå‡ºç‰Œ/é»ç‰¹å¯«å‡ºç‰Œ)
        </div>
    </div>
</div>

<!-- é¸å–®åœ–å±¤ -->
<div id="menu-overlay" class="fixed inset-0 bg-[#4a0404]/95 flex items-center justify-center z-50 p-4 md:p-6 text-white text-center backdrop-blur-md">
    <div class="max-w-md w-full border-4 border-[#d4af37] p-6 md:p-8 rounded-3xl bg-[#5a0505] shadow-[0_0_50px_rgba(0,0,0,0.8)] flex flex-col gap-4 md:gap-6">
        <div>
            <h1 class="text-4xl md:text-5xl font-black mb-2 gold-text italic">æ­å–œç™¼è²¡</h1>
            <h2 class="text-xl md:text-2xl font-bold text-yellow-100">å°æ—¥é›™åˆ¶ç«‹é«”éº»å°‡</h2>
        </div>
        
        <div>
            <p class="mb-2 md:mb-3 text-yellow-500/80 font-medium uppercase tracking-widest text-xs">é¸æ“‡æ–°æ˜¥è¦å‰‡</p>
            <div class="flex gap-4 justify-center">
                <button id="rule-jp" onclick="selectRule('JP')" class="flex-1 py-3 rounded-xl border-2 border-white/20 bg-white/5 transition-all font-bold text-sm md:text-base">æ—¥æœ¬éº»å°‡</button>
                <button id="rule-tw" onclick="selectRule('TW')" class="flex-1 py-3 rounded-xl border-2 border-white/20 bg-white/5 transition-all font-bold text-sm md:text-base">è‡ºç£éº»å°‡</button>
            </div>
        </div>

        <div class="text-left">
            <p class="mb-2 md:mb-3 text-yellow-500/80 font-medium uppercase tracking-widest text-xs text-center">æ‹›ç‰ŒéŠç©æ¨¡å¼</p>
            <select id="player-mode" class="w-full p-3 md:p-4 bg-red-900/50 rounded-xl border border-yellow-600/50 text-base md:text-lg appearance-none text-center font-bold text-yellow-100 focus:outline-none focus:border-yellow-400 transition-colors">
                <option value="1h3c">1 ä½ç©å®¶ + 3 ä½é›»è…¦</option>
                <option value="3h1c" selected>3 ä½ç©å®¶ + 1 ä½é›»è…¦</option>
                <option value="4h">4 ä½çœŸäººå°æˆ°</option>
                <option value="2h2c">2 ä½ç©å®¶ + 2 ä½é›»è…¦</option>
            </select>
        </div>

        <button onclick="startGame()" class="w-full bg-gradient-to-r from-red-600 to-red-700 hover:from-red-500 hover:to-red-600 text-white py-4 md:py-5 rounded-2xl font-black text-2xl md:text-3xl shadow-[0_0_40px_rgba(212,175,55,0.4)] border-b-8 border-red-900 active:border-b-0 active:translate-y-2 transition-all">
            é–‹ å±€ è´ ç´… åŒ… <span class="text-sm block font-normal text-yellow-300 mt-1">(è²»ç”¨: 100 ä»£å¹£)</span>
        </button>
        <p class="text-xs text-yellow-600">â€» éŸ³æ¨‚å°‡æ–¼é–‹å±€å¾Œè‡ªå‹•æ’­æ”¾ â€»</p>
    </div>
</div>

<div id="result-overlay" class="fixed inset-0 hidden items-center justify-center bg-black/90 z-[100] p-6">
    <div class="max-w-sm w-full bg-red-950 border-4 border-yellow-500 rounded-3xl p-8 text-center text-white">
        <h2 class="text-4xl font-black text-yellow-400 mb-4" id="result-title">å¤§å‰å¤§åˆ©ï¼</h2>
        <div class="text-xl mb-6" id="result-winner"></div>
        <div class="flex flex-wrap justify-center gap-1 text-3xl mb-6 p-4 rounded-xl bg-white/10" id="result-hand"></div>
        <div class="text-2xl font-bold text-yellow-300 mb-8" id="result-coins"></div>
        <button onclick="location.reload()" class="btn-festive w-full py-4 text-xl">å†é–‹ä¸€å±€</button>
    </div>
</div>

<script>
/**
 * éº»å°‡æ•¸æ“šå®šç¾©
 */
const TILE_EMOJI = {
    'M1':'ğŸ€‡','M2':'ğŸ€ˆ','M3':'ğŸ€‰','M4':'ğŸ€Š','M5':'ğŸ€‹','M6':'ğŸ€Œ','M7':'ğŸ€','M8':'ğŸ€','M9':'ğŸ€',
    'P1':'ğŸ€™','P2':'ğŸ€š','P3':'ğŸ€›','P4':'ğŸ€œ','P5':'ğŸ€','P6':'ğŸ€','P7':'ğŸ€Ÿ','P8':'ğŸ€ ','P9':'ğŸ€¡',
    'S1':'ğŸ€','S2':'ğŸ€‘','S3':'ğŸ€’','S4':'ğŸ€“','S5':'ğŸ€”','S6':'ğŸ€•','S7':'ğŸ€–','S8':'ğŸ€—','S9':'ğŸ€˜',
    'Z1':'ğŸ€€','Z2':'ğŸ€','Z3':'ğŸ€‚','Z4':'ğŸ€ƒ','Z5':'ğŸ€†','Z6':'ğŸ€…','Z7':'ğŸ€„',
    'F1':'ğŸŒ¸','F2':'ğŸŒ¿','F3':'ğŸ‹','F4':'ğŸŒ¼','F5':'â˜€ï¸','F6':'ğŸŒ¬ï¸','F7':'ğŸ‚','F8':'â„ï¸'
};

class MahjongGame {
    constructor() {
        this.scene = null;
        this.camera = null;
        this.renderer = null;
        this.controls = null;
        this.rule = 'TW';
        this.playerModes = '3h1c';
        this.hands = [[], [], [], []];
        this.melds = [[], [], [], []]; 
        this.discards = [[], [], [], []]; 
        this.flowers = [[], [], [], []]; 
        this.wall = [];
        this.turn = 0;
        this.scores = [0,0,0,0];
        this.credits = 10000; // åˆå§‹ä»£å¹£
        this.tilesObjects = [];
        this.raycaster = new THREE.Raycaster();
        this.mouse = new THREE.Vector2();
        this.selectedTile = null; 
        this.labelsGroup = new THREE.Group();
        this.pointerDownTime = 0;
        this.pointerDownPos = new THREE.Vector2();
        
        this.isInitialized = false;
        this.isGameActive = false;
        this.autoDiscardTimeout = null;
        this.waitingForAction = false;
        this.currentActionContext = null; 

        this.autoCamera = true;
        this.baseCameraPositions = [
            { pos: new THREE.Vector3(0, 24, 18), target: new THREE.Vector3(0, -3, 2) },    // P0
            { pos: new THREE.Vector3(18, 24, 0), target: new THREE.Vector3(2, -3, 0) },    // P1
            { pos: new THREE.Vector3(0, 24, -18), target: new THREE.Vector3(0, -3, -2) },  // P2
            { pos: new THREE.Vector3(-18, 24, 0), target: new THREE.Vector3(-2, -3, 0)
